<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مدیریت هزینه سفر</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Tahoma, sans-serif; direction: rtl; margin: 10px; padding:0; }
  h2 { text-align:center; }
  #budget-info { text-align:center; margin-bottom: 10px; }
  input, select, button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; font-size: 1rem; }
  form { max-width: 400px; margin: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 0.9rem; }
  @media (max-width:600px){
    table, th, td { font-size: 0.8rem; }
  }
  canvas { max-width: 100%; margin-top: 30px; }
  .container { padding: 0 10px; }
</style>
</head>
<body>

<div class="container">
<h2>مدیریت هزینه سفر</h2>

<div id="budget-info">
  <p>بودجه هتل: <span id="hotel-budget"></span> | تنخواه: <span id="petty-budget"></span> | مازاد: <span id="extra-budget"></span></p>
</div>

<form id="expense-form">
  <input type="text" id="expense-name" placeholder="شرح هزینه" required>
  <input type="number" id="expense-amount" placeholder="مبلغ" required>
  <select id="expense-type" required>
    <option value="">انتخاب بودجه</option>
    <option value="hotel">هتل</option>
    <option value="petty">تنخواه</option>
    <option value="extra">مازاد</option>
  </select>
  <button type="submit">ثبت هزینه</button>
</form>

<table>
  <thead>
    <tr>
      <th>تاریخ</th>
      <th>شرح هزینه</th>
      <th>مبلغ</th>
      <th>بودجه</th>
    </tr>
  </thead>
  <tbody id="expense-table">
  </tbody>
</table>

<canvas id="budgetChart"></canvas>
</div>

<script>
let days=0, hotelTotal=0, pettyTotal=0, extraTotal=0;
let hotelUsed=0, pettyUsed=0, extraUsed=0;

// بارگذاری بودجه از localStorage یا دیالوگ
if(!localStorage.getItem('days')){
  days=parseInt(prompt("تعداد روز سفر را وارد کنید:"));
  hotelTotal=parseFloat(prompt("بودجه کل هتل را وارد کنید:"));
  pettyTotal=parseFloat(prompt("بودجه کل تنخواه را وارد کنید:"));
  extraTotal=parseFloat(prompt("بودجه مازاد را وارد کنید:"));
  localStorage.setItem('days',days);
  localStorage.setItem('hotelTotal',hotelTotal);
  localStorage.setItem('pettyTotal',pettyTotal);
  localStorage.setItem('extraTotal',extraTotal);
}else{
  days=parseInt(localStorage.getItem('days'));
  hotelTotal=parseFloat(localStorage.getItem('hotelTotal'));
  pettyTotal=parseFloat(localStorage.getItem('pettyTotal'));
  extraTotal=parseFloat(localStorage.getItem('extraTotal'));
}

// آپدیت نمایش بودجه
function updateBudgetInfo(){
  document.getElementById('hotel-budget').innerText = hotelTotal - hotelUsed;
  document.getElementById('petty-budget').innerText = pettyTotal - pettyUsed;
  document.getElementById('extra-budget').innerText = extraTotal - extraUsed;
}

// بارگذاری هزینه‌ها
let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
expenses.forEach(e=>{
  addExpenseRow(e);
  if(e.type==='hotel') hotelUsed+=e.amount;
  else if(e.type==='petty') pettyUsed+=e.amount;
  else extraUsed+=e.amount;
});
updateBudgetInfo();

// ثبت هزینه جدید
document.getElementById('expense-form').addEventListener('submit',function(e){
  e.preventDefault();
  let name=document.getElementById('expense-name').value;
  let amount=parseFloat(document.getElementById('expense-amount').value);
  let type=document.getElementById('expense-type').value;
  let date=new Date().toLocaleDateString('fa-IR');
  let expense={name,amount,type,date};
  expenses.push(expense);
  localStorage.setItem('expenses',JSON.stringify(expenses));
  addExpenseRow(expense);

  if(type==='hotel') hotelUsed+=amount;
  else if(type==='petty') pettyUsed+=amount;
  else extraUsed+=amount;

  updateBudgetInfo();
  updateChart();
  this.reset();
});

// افزودن ردیف به جدول
function addExpenseRow(expense){
  let table=document.getElementById('expense-table');
  let row=table.insertRow();
  row.insertCell(0).innerText=expense.date;
  row.insertCell(1).innerText=expense.name;
  row.insertCell(2).innerText=expense.amount;
  row.insertCell(3).innerText=expense.type==='hotel'?'هتل':(expense.type==='petty'?'تنخواه':'مازاد');
}

// چارت
let ctx=document.getElementById('budgetChart').getContext('2d');
let budgetChart=new Chart(ctx,{
  type:'doughnut',
  data:{
    labels:['هتل مصرف شده','هتل باقیمانده','تنخواه مصرف شده','تنخواه باقیمانده','مازاد مصرف شده','مازاد باقیمانده'],
    datasets:[{
      data:[hotelUsed,hotelTotal-hotelUsed,pettyUsed,pettyTotal-pettyUsed,extraUsed,extraTotal-extraUsed],
      backgroundColor:['#FF6384','#FFCDD2','#36A2EB','#B3E5FC','#FFCE56','#FFF9C4']
    }]
  },
  options:{
    responsive:true,
    plugins:{legend:{position:'bottom'}}
  }
});

function updateChart(){
  budgetChart.data.datasets[0].data=[hotelUsed,hotelTotal-hotelUsed,pettyUsed,pettyTotal-pettyUsed,extraUsed,extraTotal-extraUsed];
  budgetChart.update();
}
</script>

</body>
</html>
