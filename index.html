<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دستیار مالی سفرهای خارجی - ذخیره محلی</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on the 'dark' class
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Tahoma', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Load React, ReactDOM, and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Base styling for the app - better mobile experience */
        body {
            margin: 0;
            padding: 0;
            background-color: #f7f9fc; /* Light background for non-dark mode */
        }
        .dark body {
            background-color: #0f172a; /* Slate-900 for dark mode */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Global dependencies are available via window object (React, ReactDOM)
        // We use window.localStorage directly.

        // --- CONSTANTS ---
        const LS_KEY_TRIPS = 'expenseTracker_trips';
        const LS_KEY_EXPENSES = 'expenseTracker_expenses';
        const LS_KEY_SETTINGS = 'expenseTracker_settings';

        const CURRENCY_MAP = {
            'چین': { code: 'CNY', symbol: '¥', flag: '🇨🇳', defaultRate: 7.1 },
            'دبی': { code: 'AED', symbol: 'د.إ', flag: '🇦🇪', defaultRate: 3.67 },
            'ترکیه': { code: 'TRY', symbol: '₺', flag: '🇹🇷', defaultRate: 41.69 },
        };

        const EXPENSE_CATEGORIES = ['هدیه', 'غذا', 'تاکسی', 'مترو', 'هتل'];

        // Color Palette for charts and overall theme
        const COLORS = {
            primary: 'bg-blue-600 hover:bg-blue-700',
            primaryText: 'text-white',
            secondaryBg: 'bg-gray-100 dark:bg-gray-800',
            tertiaryBg: 'bg-white dark:bg-gray-900',
            lightText: 'text-gray-900 dark:text-gray-100',
            mutedText: 'text-gray-500 dark:text-gray-400',
            danger: 'text-red-500',
            warning: 'bg-red-100 dark:bg-red-800',
            gaugeTrack: 'bg-gray-300 dark:bg-gray-700',
        };

        // --- LOCAL STORAGE HANDLERS ---
        const loadFromLocalStorage = (key, defaultValue) => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (error) {
                console.error("Error loading state from localStorage", error);
                return defaultValue;
            }
        };

        const saveToLocalStorage = (key, value) => {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (error) {
                console.error("Error saving state to localStorage", error);
            }
        };


        // --- UTILITY FUNCTIONS ---
        const generateUniqueId = () => Math.random().toString(36).substr(2, 9);
        const toUSD = (amount, currencyCode, rates) => {
            const rate = rates[currencyCode] || 1;
            return amount / rate;
        };
        // Removed fromUSD as it's not used in current logic

        // --- REACT COMPONENTS (All components from previous version are copied here) ---
        // I will only include the core components and handlers that changed (App, HomeScreen, etc.)
        // and assume all sub-components (Dialog, Input, GaugeChart, etc.) are included here for brevity.
        
        // 1. SplashScreen
        const SplashScreen = ({ isVisible }) => {
            if (!isVisible) return null;

            return (
                <div 
                    className="fixed inset-0 z-50 flex flex-col items-center justify-center transition-opacity duration-1000"
                    style={{ 
                        background: 'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)', // Blue to Navy Gradient
                        opacity: isVisible ? 1 : 0
                    }}
                >
                    <div className="text-center text-white p-6 rounded-xl animate-pulse">
                        <h1 className="text-4xl font-extrabold mb-3 shadow-lg">
                            دستیار مالی سفرهای خارجی
                        </h1>
                        <p className="text-xl font-light opacity-80 mt-6">
                            نوشته شده با ❤️ توسط محمد صادقی کاجی
                        </p>
                        <p className="text-xs mt-10 opacity-70">
                            (ذخیره اطلاعات به صورت محلی در مرورگر شما)
                        </p>
                    </div>
                </div>
            );
        };

        // 2. NavItem and NavBar (Unchanged except for the removed authReady logic)
        const NavItem = ({ name, screen, icon, currentScreen, onNavigate, enabled }) => {
            const isActive = currentScreen === screen;
            const isDisabled = !enabled;

            return (
                <button
                    onClick={() => !isDisabled && onNavigate(screen)}
                    disabled={isDisabled}
                    className={`
                        flex flex-col items-center text-xs p-1 h-full transition-colors duration-200
                        ${isDisabled 
                            ? 'text-gray-400 dark:text-gray-600 cursor-not-allowed' 
                            : (isActive ? 'text-blue-600 dark:text-blue-400' : 'text-gray-700 dark:text-gray-300 hover:text-blue-500 dark:hover:text-blue-300')
                        }
                    `}
                >
                    <span className="text-xl mb-0.5">{icon}</span>
                    <span className="font-medium">{name}</span>
                </button>
            );
        };

        const NavBar = ({ currentScreen, onNavigate, selectedTrip }) => {
            const isTripSelected = !!selectedTrip;

            const navItems = [
                { name: 'خانه', screen: 'home', icon: '🏠', enabled: true },
                { name: 'گزارشات', screen: 'reports', icon: '📊', enabled: isTripSelected },
                { name: 'تنظیمات', screen: 'settings', icon: '⚙️', enabled: isTripSelected },
                { name: 'درباره', screen: 'about', icon: 'ℹ️', enabled: true },
            ];

            const PlusButton = () => (
                <button
                    onClick={() => onNavigate('plus')}
                    className={`
                        ${COLORS.primary} w-16 h-16 rounded-full -mt-8 shadow-xl 
                        flex items-center justify-center text-3xl transition-transform
                        transform hover:scale-105 active:scale-95 z-20 
                        ${COLORS.primaryText}
                    `}
                    aria-label={isTripSelected ? "ثبت هزینه جدید" : "ثبت سفر جدید"}
                >
                    ➕
                </button>
            );

            return (
                <nav className={`${COLORS.tertiaryBg} shadow-2xl fixed bottom-0 left-0 right-0 z-40 border-t border-gray-200 dark:border-gray-700 h-16`}>
                    <div className="flex justify-around items-end h-full pt-2">
                        {navItems.slice(0, 1).map(item => (
                            <NavItem key={item.name} {...item} currentScreen={currentScreen} onNavigate={onNavigate} />
                        ))}
                        <PlusButton />
                        {navItems.slice(1).map(item => (
                            <NavItem key={item.name} {...item} currentScreen={currentScreen} onNavigate={onNavigate} />
                        ))}
                    </div>
                </nav>
            );
        };

        // 3. Utility Components (Dialog, Input, Button) - Unchanged

        const Dialog = ({ title, children, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                <div 
                    className={`${COLORS.tertiaryBg} rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all`} 
                    onClick={e => e.stopPropagation()} 
                >
                    <div className="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                        <h3 className="text-lg font-bold">{title}</h3>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl" aria-label="بستن">
                            &times;
                        </button>
                    </div>
                    <div className="p-4">
                        {children}
                    </div>
                </div>
            </div>
        );

        const Label = ({ htmlFor, children }) => (
            <label htmlFor={htmlFor} className="block text-sm font-medium mb-1">
                {children}
            </label>
        );

        const Input = ({ label, type = 'text', value, onChange, placeholder = '', ...props }) => (
            <div>
                <Label htmlFor={label}>{label}</Label>
                <input
                    id={label}
                    type={type}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100 mt-1"
                    {...props}
                />
            </div>
        );

        const Button = ({ children, onClick, className = '' }) => (
            <button
                onClick={onClick}
                className={`px-4 py-2 rounded-lg font-bold transition-all transform hover:scale-[1.02] active:scale-[0.98] ${COLORS.primary} ${COLORS.primaryText} shadow-md ${className}`}
            >
                {children}
            </button>
        );

        // 4. NewTripDialog (Unchanged)
        const NewTripDialog = ({ onSave, onClose }) => {
            const [name, setName] = React.useState('');
            const [destination, setDestination] = React.useState('');
            const [budget, setBudget] = React.useState('');
            const [currencyInfo, setCurrencyInfo] = React.useState(null);

            React.useEffect(() => {
                if (destination) {
                    setCurrencyInfo(CURRENCY_MAP[destination]);
                } else {
                    setCurrencyInfo(null);
                }
            }, [destination]);

            const handleSave = () => {
                if (!name || !destination || !budget || isNaN(parseFloat(budget))) {
                    alert("لطفاً همه فیلدها را به درستی پر کنید."); 
                    return;
                }
                onSave({
                    id: generateUniqueId(), // Generating ID locally
                    name: name,
                    destination: destination,
                    budget: parseFloat(budget),
                    currencyCode: currencyInfo.code,
                    createdAt: new Date().toISOString(),
                    spent: 0,
                });
                onClose();
            };

            return (
                <Dialog title="ثبت سفر جدید" onClose={onClose}>
                    <div className="space-y-4">
                        <Input label="نام سفر" value={name} onChange={e => setName(e.target.value)} />
                        
                        <div>
                            <Label htmlFor="destination">مقصد</Label>
                            <select
                                id="destination"
                                value={destination}
                                onChange={e => setDestination(e.target.value)}
                                className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100 mt-1"
                            >
                                <option value="">انتخاب مقصد...</option>
                                {Object.keys(CURRENCY_MAP).map(dest => (
                                    <option key={dest} value={dest}>
                                        {CURRENCY_MAP[dest].flag} {dest}
                                    </option>
                                ))}
                            </select>
                        </div>

                        {currencyInfo && (
                            <div className="flex justify-between items-center text-sm">
                                <span className={COLORS.mutedText}>ارز پیش‌فرض:</span>
                                <span className="font-bold">{currencyInfo.flag} {currencyInfo.code} ({currencyInfo.symbol})</span>
                            </div>
                        )}
                        
                        <Input 
                            label="بودجه پیش‌فرض (USD)" 
                            type="number" 
                            value={budget} 
                            onChange={e => setBudget(e.target.value)} 
                            placeholder="مثال: 2000"
                        />

                        <Button onClick={handleSave} className="w-full mt-6">ثبت سفر</Button>
                    </div>
                </Dialog>
            );
        };
        
        // 5. NewExpenseDialog (Unchanged)
        const NewExpenseDialog = ({ onSave, onClose, trip, rates }) => {
            const [category, setCategory] = React.useState(EXPENSE_CATEGORIES[0]);
            const [description, setDescription] = React.useState('');
            const [amount, setAmount] = React.useState('');
            const currencyInfo = CURRENCY_MAP[trip.destination];

            const handleSave = () => {
                if (!category || !description || !amount || isNaN(parseFloat(amount))) {
                    alert("لطفاً همه فیلدها را به درستی پر کنید.");
                    return;
                }

                const amountForeign = parseFloat(amount);
                const amountUSD = toUSD(amountForeign, trip.currencyCode, rates);
                
                onSave({
                    id: generateUniqueId(), // Generating ID locally
                    tripId: trip.id,
                    category: category,
                    description: description,
                    amountForeign: amountForeign,
                    currencyCode: trip.currencyCode,
                    amountUSD: amountUSD,
                    date: new Date().toISOString().split('T')[0], // YYYY-MM-DD
                    timestamp: Date.now(),
                });
                onClose();
            };

            return (
                <Dialog title={`ثبت هزینه برای ${trip.name}`} onClose={onClose}>
                    <div className="space-y-4">
                        <div>
                            <Label htmlFor="category">نوع هزینه</Label>
                            <select
                                id="category"
                                value={category}
                                onChange={e => setCategory(e.target.value)}
                                className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100 mt-1"
                            >
                                {EXPENSE_CATEGORIES.map(cat => (
                                    <option key={cat} value={cat}>{cat}</option>
                                ))}
                            </select>
                        </div>

                        <Input label="شرح هزینه" value={description} onChange={e => setDescription(e.target.value)} />

                        <div>
                            <Label htmlFor="amount">مبلغ</Label>
                            <div className="flex items-center space-x-2 space-x-reverse">
                                <input
                                    id="amount"
                                    type="number"
                                    value={amount}
                                    onChange={e => setAmount(e.target.value)}
                                    placeholder="مقدار"
                                    className="flex-grow p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-gray-100"
                                />
                                <span className={`${COLORS.mutedText} font-bold text-lg p-2 rounded-lg`}>
                                    {currencyInfo.symbol} ({currencyInfo.code})
                                </span>
                            </div>
                        </div>

                        <Button onClick={handleSave} className="w-full mt-6">ثبت هزینه</Button>
                    </div>
                </Dialog>
            );
        };
        
        // 6. GaugeChart Component (Unchanged)
        const GaugeChart = ({ percentage }) => {
            const radius = 50;
            const circumference = 2 * Math.PI * radius;
            const progress = (percentage / 100) * circumference;
            const dashoffset = circumference - progress;
            
            let color = 'text-green-500';
            if (percentage > 75) color = 'text-yellow-500';
            if (percentage > 100) color = 'text-red-500';

            return (
                <div className="relative flex items-center justify-center w-full max-w-xs mx-auto">
                    <svg className="w-40 h-40 transform -rotate-90" viewBox="0 0 120 120">
                        <circle 
                            cx="60" 
                            cy="60" 
                            r={radius} 
                            fill="none" 
                            stroke="currentColor" 
                            strokeWidth="10" 
                            className="text-gray-300 dark:text-gray-700" 
                        />
                        <circle 
                            cx="60" 
                            cy="60" 
                            r={radius} 
                            fill="none" 
                            stroke="currentColor" 
                            strokeWidth="10" 
                            strokeDasharray={circumference}
                            strokeDashoffset={dashoffset}
                            strokeLinecap="round"
                            className={color}
                            style={{ transition: 'stroke-dashoffset 0.5s ease-in-out' }}
                        />
                    </svg>
                    <div className={`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center`}>
                        <span className={`text-2xl font-bold ${color}`}>{Math.round(percentage)}%</span>
                    </div>
                </div>
            );
        };

        // 7. PieChart Component (Unchanged)
        const PieChart = ({ data }) => {
            if (!data || data.length === 0) {
                return <div className="text-center p-4">داده‌ای برای نمایش نمودار هزینه وجود ندارد.</div>;
            }

            const total = data.reduce((sum, item) => sum + item.amountUSD, 0);
            let startAngle = 0;

            const categoryColors = {
                'هتل': '#f87171',   // Red
                'غذا': '#34d399',    // Green
                'تاکسی': '#60a5fa', // Blue
                'مترو': '#facc15',   // Yellow
                'هدیه': '#c084fc',   // Purple
                'سایر': '#9ca3af',   // Gray
            };

            const segments = data.map((item, index) => {
                const percentage = total > 0 ? (item.amountUSD / total) : 0;
                const endAngle = startAngle + percentage * 360;
                
                const toX = (angle) => 50 + 50 * Math.cos(angle * Math.PI / 180);
                const toY = (angle) => 50 + 50 * Math.sin(angle * Math.PI / 180);

                const x1 = toX(startAngle);
                const y1 = toY(startAngle);
                const x2 = toX(endAngle);
                const y2 = toY(endAngle);

                const largeArcFlag = percentage > 0.5 ? 1 : 0;
                const color = categoryColors[item.category] || categoryColors['سایر'];

                const d = [
                    `M 50,50`,
                    `L ${x1},${y1}`,
                    `A 50,50 0 ${largeArcFlag} 1 ${x2},${y2}`,
                    `Z`
                ].join(' ');

                const segment = {
                    category: item.category,
                    percentage: (percentage * 100).toFixed(1),
                    color: color,
                    d: d,
                };

                startAngle = endAngle;
                return segment;
            });

            return (
                <div className="flex flex-col lg:flex-row items-center justify-center p-4">
                    <svg viewBox="0 0 100 100" className="w-48 h-48 flex-shrink-0">
                        {segments.map((segment, index) => (
                            <path
                                key={index}
                                d={segment.d}
                                fill={segment.color}
                                className="transition-opacity duration-300 hover:opacity-80"
                            />
                        ))}
                    </svg>

                    <div className="w-full lg:w-auto mt-6 lg:mt-0 lg:mr-8 text-sm space-y-2">
                        <h4 className="font-bold border-b pb-1 mb-2">راهنمای دسته‌بندی‌ها (USD)</h4>
                        {segments.map((segment, index) => (
                            <div key={index} className="flex justify-between items-center">
                                <div className="flex items-center">
                                    <span 
                                        className="w-3 h-3 rounded-full mr-2" 
                                        style={{ backgroundColor: segment.color }}
                                    ></span>
                                    <span className={COLORS.lightText}>{segment.category}</span>
                                </div>
                                <span className="font-mono text-gray-700 dark:text-gray-300">
                                    {segment.percentage}%
                                </span>
                            </div>
                        ))}
                        <div className="pt-2 border-t dark:border-gray-700 flex justify-between font-bold">
                            <span>جمع کل:</span>
                            <span>${total.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            );
        };
        
        // 8. HomeScreen (Simplified, removed auth checks)
        const HomeScreen = ({ trips, onSelectTrip, selectedTrip }) => {
            if (!trips || trips.length === 0) {
                return (
                    <div className="flex flex-col items-center justify-center h-full text-center p-6">
                        <h2 className="text-xl font-semibold mb-4">
                            سفر جدیدی ثبت نشده است!
                        </h2>
                        <p className={COLORS.mutedText}>
                            برای شروع، روی دکمه <span className="text-blue-500 font-bold">➕</span> در پایین صفحه کلیک کنید و اولین سفر خود را ثبت نمایید.
                        </p>
                        <p className="mt-8 text-xs font-medium p-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-lg">
                            ⚠️ اطلاعات شما به صورت **محلی** در مرورگر ذخیره می‌شود. با پاک کردن کش مرورگر، اطلاعات پاک خواهند شد.
                        </p>
                    </div>
                );
            }

            const totalSpent = trips.reduce((sum, trip) => sum + (trip.spentUSD || 0), 0).toFixed(2);
            const totalBudget = trips.reduce((sum, trip) => sum + trip.budget, 0).toFixed(2);

            return (
                <div className="space-y-4 p-4 pb-20">
                    <div className="flex justify-between p-3 rounded-xl bg-blue-100 dark:bg-blue-900 shadow-lg border border-blue-200 dark:border-blue-800">
                        <div className="text-sm font-medium">
                            <p className="text-blue-800 dark:text-blue-200">جمع کل هزینه‌ها:</p>
                            <p className="text-xl font-bold text-blue-900 dark:text-blue-100">${totalSpent}</p>
                        </div>
                        <div className="text-sm font-medium text-left">
                            <p className="text-blue-800 dark:text-blue-200">جمع کل بودجه:</p>
                            <p className="text-xl font-bold text-blue-900 dark:text-blue-100">${totalBudget}</p>
                        </div>
                    </div>
                    
                    <h2 className="text-lg font-bold pt-4 pb-2 border-b dark:border-gray-700">لیست سفرها</h2>
                    
                    <div className="space-y-3">
                        {trips.map(trip => {
                            const percentageSpent = trip.budget > 0 ? ((trip.spentUSD || 0) / trip.budget) * 100 : 0;
                            const isOverBudget = percentageSpent > 100;
                            const currencyInfo = CURRENCY_MAP[trip.destination];

                            return (
                                <div
                                    key={trip.id}
                                    onClick={() => onSelectTrip(trip.id)}
                                    className={`p-4 rounded-xl shadow-lg cursor-pointer transition-all border 
                                        ${trip.id === selectedTrip?.id 
                                            ? 'border-blue-500 bg-blue-50 dark:bg-blue-950' 
                                            : 'border-gray-200 dark:border-gray-700 hover:shadow-xl hover:bg-gray-50 dark:hover:bg-gray-800'
                                        }
                                    `}
                                >
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="text-xl font-bold flex items-center">
                                            {currencyInfo.flag} {trip.name}
                                        </h3>
                                        <span className={`${COLORS.mutedText} text-sm`}>
                                            بودجه: <span className="font-bold">${trip.budget.toFixed(2)}</span>
                                        </span>
                                    </div>
                                    
                                    <div className="flex justify-between items-center text-sm mb-2">
                                        <p className={`font-semibold ${isOverBudget ? COLORS.danger : 'text-green-600 dark:text-green-400'}`}>
                                            هزینه شده: <span className="font-bold">${(trip.spentUSD || 0).toFixed(2)}</span>
                                        </p>
                                        <span className={COLORS.mutedText}>
                                            {currencyInfo.code}
                                        </span>
                                    </div>

                                    <div className="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700 mt-2">
                                        <div 
                                            className={`h-2 rounded-full transition-all duration-500 ${isOverBudget ? 'bg-red-500' : 'bg-blue-500'}`} 
                                            style={{ width: `${Math.min(percentageSpent, 100)}%` }}
                                        ></div>
                                    </div>
                                    {isOverBudget && <p className="text-red-500 text-xs mt-1 font-medium">!از بودجه تعیین شده عبور کرده‌اید</p>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        
        // 9. ReportsScreen (Unchanged)
        const ReportsScreen = ({ selectedTrip, expenses, rates }) => {
            const expensesForTrip = expenses.filter(e => e.tripId === selectedTrip.id);

            if (expensesForTrip.length === 0) {
                return (
                    <div className="text-center p-6 pt-12">
                        <h2 className="text-xl font-bold mb-4">گزارشات</h2>
                        <p className={COLORS.mutedText}>
                            هنوز هزینه‌ای برای سفر <span className="font-bold">{selectedTrip.name}</span> ثبت نشده است.
                        </p>
                    </div>
                );
            }

            const totalSpentUSD = expensesForTrip.reduce((sum, e) => sum + e.amountUSD, 0);
            const percentage = selectedTrip.budget > 0 ? (totalSpentUSD / selectedTrip.budget) * 100 : 0;

            const categoryData = expensesForTrip.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + expense.amountUSD;
                return acc;
            }, {});
            const pieChartData = Object.entries(categoryData).map(([category, amountUSD]) => ({
                category,
                amountUSD,
            }));

            const dailyExpenses = expensesForTrip.reduce((acc, expense) => {
                const date = expense.date; 
                if (!acc[date]) {
                    acc[date] = { hotel: 0, perDiem: 0, all: 0, details: [] };
                }
                
                acc[date].all += expense.amountUSD;
                if (expense.category === 'هتل') {
                    acc[date].hotel += expense.amountUSD;
                } else {
                    acc[date].perDiem += expense.amountUSD;
                }

                acc[date].details.push(expense);
                return acc;
            }, {});

            const dailyAlerts = Object.entries(dailyExpenses)
                .filter(([, data]) => data.hotel > 120 || data.perDiem > 40)
                .sort(([dateA], [dateB]) => new Date(dateB) - new Date(dateA)); 

            return (
                <div className="p-4 pb-20 space-y-8">
                    <h2 className="text-2xl font-bold text-center border-b pb-3 dark:border-gray-700">
                        گزارش سفر: <span className="text-blue-600 dark:text-blue-400">{selectedTrip.name}</span>
                    </h2>

                    <div className={`${COLORS.secondaryBg} p-4 rounded-xl shadow-inner`}>
                        <h3 className="text-lg font-bold mb-4 text-center">پول خرج شده نسبت به کل بودجه</h3>
                        <GaugeChart percentage={percentage} />
                        <div className="text-center mt-4">
                            <p className={COLORS.mutedText}>بودجه: ${selectedTrip.budget.toFixed(2)}</p>
                            <p className="text-xl font-bold">${totalSpentUSD.toFixed(2)} <span className="text-sm">هزینه شده</span></p>
                            {percentage > 100 && <p className="text-red-500 font-bold mt-2">!!!از بودجه کل عبور کرده‌اید</p>}
                        </div>
                    </div>
                    
                    <div className={`${COLORS.secondaryBg} p-4 rounded-xl shadow-inner`}>
                        <h3 className="text-lg font-bold mb-4 text-center">تفکیک هزینه‌ها بر اساس دسته‌بندی</h3>
                        <PieChart data={pieChartData} />
                    </div>

                    {dailyAlerts.length > 0 && (
                        <div className={`${COLORS.warning} p-4 rounded-xl border border-red-500 shadow-md space-y-3`}>
                            <h3 className="text-red-700 dark:text-red-300 font-bold flex items-center">
                                ⚠️ اخطار محدودیت هزینه‌های روزانه
                            </h3>
                            <p className="text-sm text-red-600 dark:text-red-200">
                                حداکثر روزانه هتل: $120. حداکثر تنخواه روزانه (سایر): $40.
                            </p>
                            {dailyAlerts.map(([date, data]) => (
                                <div key={date} className="p-3 bg-red-50 dark:bg-red-900 rounded-lg border border-red-300">
                                    <h4 className="font-bold text-red-700 dark:text-red-300">{date}</h4>
                                    {data.hotel > 120 && (
                                        <p className="text-sm">
                                            <span className="font-semibold">هزینه هتل:</span> ${data.hotel.toFixed(2)} (بیشتر از $120)
                                        </p>
                                    )}
                                    {data.perDiem > 40 && (
                                        <p className="text-sm">
                                            <span className="font-semibold">تنخواه روزانه:</span> ${data.perDiem.toFixed(2)} (بیشتر از $40)
                                        </p>
                                    )}
                                    <p className="text-xs mt-1 text-red-500 dark:text-red-400">
                                        مجموع کل روز: ${data.all.toFixed(2)}
                                    </p>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        
        // 10. SettingsScreen (Uses local state management)
        const SettingsScreen = ({ theme, onThemeChange, autoDarkMode, onToggleAutoDarkMode, rates, onSaveRates }) => {
            const [localRates, setLocalRates] = React.useState(rates);

            React.useEffect(() => {
                setLocalRates(rates);
            }, [rates]);

            const handleRateChange = (code, value) => {
                setLocalRates(prev => ({
                    ...prev,
                    [code]: parseFloat(value) || 0,
                }));
            };

            const handleSave = () => {
                onSaveRates(localRates);
            };

            const rateKeys = Object.values(CURRENCY_MAP).map(info => info.code);

            return (
                <div className="p-4 pb-20 space-y-6">
                    <h2 className="text-2xl font-bold text-center border-b pb-3 dark:border-gray-700">تنظیمات</h2>

                    <div className={`${COLORS.secondaryBg} p-4 rounded-xl shadow-inner space-y-3`}>
                        <h3 className="text-lg font-bold border-b pb-2">تنظیمات تم</h3>
                        
                        <div className="flex justify-between items-center">
                            <span className="font-medium">حالت شب (Dark Mode)</span>
                            <label className="relative inline-flex items-center cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    checked={theme === 'dark'} 
                                    onChange={() => onThemeChange(theme === 'dark' ? 'light' : 'dark')} 
                                    className="sr-only peer"
                                />
                                <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                <span className="mr-3 text-sm font-medium">{theme === 'dark' ? 'فعال' : 'غیرفعال'}</span>
                            </label>
                        </div>

                        <div className="flex items-center pt-2 border-t dark:border-gray-700">
                            <input 
                                id="auto-dark-mode" 
                                type="checkbox" 
                                checked={autoDarkMode} 
                                onChange={onToggleAutoDarkMode} 
                                className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
                            />
                            <label htmlFor="auto-dark-mode" className="mr-2 text-sm font-medium">
                                دارک مد خودکار (بر اساس تنظیمات دستگاه)
                            </label>
                        </div>
                    </div>

                    <div className={`${COLORS.secondaryBg} p-4 rounded-xl shadow-inner space-y-3`}>
                        <h3 className="text-lg font-bold border-b pb-2">نرخ تبدیل ارز (USD به واحد محلی)</h3>
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            مقدار ارز محلی که با 1 دلار آمریکا (USD) دریافت می‌شود را وارد کنید.
                        </p>
                        
                        {rateKeys.map(code => {
                            const info = Object.values(CURRENCY_MAP).find(c => c.code === code);
                            return (
                                <div key={code} className="flex items-center space-x-4 space-x-reverse">
                                    <span className="w-12 text-2xl text-center">{info.flag}</span>
                                    <span className="w-20 font-medium">{info.code}</span>
                                    <Input 
                                        label={`1 USD = ${info.code}`}
                                        type="number"
                                        value={localRates[code] || ''}
                                        onChange={(e) => handleRateChange(code, e.target.value)}
                                        placeholder={`نرخ ${info.code}`}
                                        className="flex-grow"
                                        style={{ direction: 'ltr' }}
                                    />
                                </div>
                            );
                        })}
                        
                        <Button onClick={handleSave} className="w-full mt-6">ذخیره و اعمال تغییرات</Button>
                    </div>
                </div>
            );
        };
        
        // 11. AboutScreen (Unchanged)
        const AboutScreen = () => (
            <div className="flex items-center justify-center h-full text-center p-6">
                <h2 className="text-2xl font-bold p-8 rounded-xl border border-dashed border-blue-400 dark:border-blue-600">
                    نوشته شده با ❤️ توسط محمد صادقی کاجی
                </h2>
            </div>
        );
        
        // 12. LoadingIndicator (Simplified)
        const LoadingIndicator = ({ message = "در حال بارگذاری..." }) => (
            <div className="flex flex-col items-center justify-center h-full text-center p-6">
                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 dark:border-blue-400 mb-3"></div>
                <p className="font-medium">{message}</p>
            </div>
        );


        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [React, ReactDOM] = [window.React, window.ReactDOM];
            
            // --- Initial State Loading (localStorage) ---
            const initialSettings = loadFromLocalStorage(LS_KEY_SETTINGS, { 
                theme: 'light', 
                autoDarkMode: true, 
                rates: { 
                    'CNY': CURRENCY_MAP['چین'].defaultRate, 
                    'AED': CURRENCY_MAP['دبی'].defaultRate, 
                    'TRY': CURRENCY_MAP['ترکیه'].defaultRate 
                }
            });

            const [trips, setTrips] = React.useState(loadFromLocalStorage(LS_KEY_TRIPS, []));
            const [expenses, setExpenses] = React.useState(loadFromLocalStorage(LS_KEY_EXPENSES, []));
            
            // Settings State
            const [theme, setTheme] = React.useState(initialSettings.theme); 
            const [autoDarkMode, setAutoDarkMode] = React.useState(initialSettings.autoDarkMode);
            const [rates, setRates] = React.useState(initialSettings.rates);

            // UI State
            const [selectedTripId, setSelectedTripId] = React.useState(null);
            const [currentScreen, setCurrentScreen] = React.useState('home');
            const [isSplashVisible, setIsSplashVisible] = React.useState(true);
            const [showModal, setShowModal] = React.useState(null); 
            const [isLoading, setIsLoading] = React.useState(false); // Used instead of authReady

            // --- Derived State ---
            const selectedTrip = React.useMemo(() => trips.find(t => t.id === selectedTripId), [trips, selectedTripId]);
            
            React.useEffect(() => {
                if (!selectedTripId && trips.length > 0) {
                    setSelectedTripId(trips[0].id);
                }
            }, [trips, selectedTripId]);


            // --- Local Storage Synchronization ---

            // Save Trips
            React.useEffect(() => {
                saveToLocalStorage(LS_KEY_TRIPS, trips);
            }, [trips]);

            // Save Expenses
            React.useEffect(() => {
                saveToLocalStorage(LS_KEY_EXPENSES, expenses);
            }, [expenses]);
            
            // Update Spent amount on trips whenever expenses or rates change
            React.useEffect(() => {
                const newTrips = trips.map(trip => {
                    const totalSpent = expenses
                        .filter(e => e.tripId === trip.id)
                        .reduce((sum, e) => sum + e.amountUSD, 0);
                    
                    // Only update if the spent amount has significantly changed
                    if (Math.abs(trip.spentUSD - totalSpent) > 0.01) {
                        return { ...trip, spentUSD: totalSpent };
                    }
                    return trip;
                });

                // Only set state if the array content has changed to avoid unnecessary re-renders
                if (JSON.stringify(trips) !== JSON.stringify(newTrips)) {
                    setTrips(newTrips);
                }
                
            }, [expenses, rates, trips]);


            // --- Splash Screen Timeout ---
            React.useEffect(() => {
                const timer = setTimeout(() => {
                    setIsSplashVisible(false);
                    // Simulate loading finish after initial local load
                    setIsLoading(false); 
                }, 3000); 
                return () => clearTimeout(timer);
            }, []);


            // --- UI/Navigation Logic ---

            const handleNavigate = (screen) => {
                if (screen === 'plus') {
                    if (!selectedTrip) {
                        setShowModal('newTrip');
                    } else {
                        setShowModal('newExpense');
                    }
                } else {
                    setCurrentScreen(screen);
                }
            };

            // --- Persistence Handlers (Settings) ---

            const saveLocalSettings = (newSettings) => {
                const finalSettings = { 
                    theme: newSettings.theme !== undefined ? newSettings.theme : theme,
                    autoDarkMode: newSettings.autoDarkMode !== undefined ? newSettings.autoDarkMode : autoDarkMode,
                    rates: newSettings.rates !== undefined ? newSettings.rates : rates,
                };
                saveToLocalStorage(LS_KEY_SETTINGS, finalSettings);
            };

            React.useEffect(() => {
                if (autoDarkMode) {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    setTheme(prefersDark ? 'dark' : 'light');
                }
            }, [autoDarkMode]);

            React.useEffect(() => {
                document.documentElement.classList.toggle('dark', theme === 'dark');
            }, [theme]);

            const handleThemeChange = (newTheme) => {
                setTheme(newTheme);
                setAutoDarkMode(false); 
                saveLocalSettings({ theme: newTheme, autoDarkMode: false });
            };

            const handleToggleAutoDarkMode = () => {
                const newState = !autoDarkMode;
                setAutoDarkMode(newState);
                if (newState) {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    setTheme(prefersDark ? 'dark' : 'light');
                }
                saveLocalSettings({ autoDarkMode: newState });
            };

            const handleSaveRates = (newRates) => {
                setRates(newRates);
                saveLocalSettings({ rates: newRates });
            };

            // --- Write Functions (Local Storage) ---

            const handleSaveNewTrip = async (newTripData) => {
                setTrips(prev => [newTripData, ...prev]); // Add new trip to state
                setSelectedTripId(newTripData.id);
                setCurrentScreen('home');
            };

            const handleSaveNewExpense = async (newExpenseData) => {
                setExpenses(prev => [newExpenseData, ...prev]); // Add new expense to state
            };


            // --- Screen Renderer ---
            const renderContent = () => {
                if (isLoading) {
                    return <LoadingIndicator message="در حال آماده‌سازی برنامه..." />;
                }
                
                switch (currentScreen) {
                    case 'home':
                        return <HomeScreen 
                            trips={trips} 
                            onSelectTrip={setSelectedTripId} 
                            selectedTrip={selectedTrip}
                        />;
                    case 'reports':
                        return selectedTrip 
                            ? <ReportsScreen selectedTrip={selectedTrip} expenses={expenses} rates={rates} />
                            : <div className="p-6 text-center text-red-500 font-bold">⚠️ ابتدا یک سفر را انتخاب کنید.</div>;
                    case 'settings':
                        return <SettingsScreen 
                            theme={theme} 
                            onThemeChange={handleThemeChange} 
                            autoDarkMode={autoDarkMode} 
                            onToggleAutoDarkMode={handleToggleAutoDarkMode}
                            rates={rates}
                            onSaveRates={handleSaveRates}
                        />;
                    case 'about':
                        return <AboutScreen />;
                    default:
                        return <HomeScreen 
                            trips={trips} 
                            onSelectTrip={setSelectedTripId} 
                            selectedTrip={selectedTrip}
                        />;
                }
            };

            return (
                <div className={`min-h-screen ${COLORS.tertiaryBg} ${COLORS.lightText} flex flex-col`} style={{ direction: 'rtl' }}>
                    <style>
                        {`
                        html { font-family: 'Inter', sans-serif; }
                        .main-content { padding-top: 5rem; padding-bottom: 5rem; flex-grow: 1; }
                        .dark ::-webkit-scrollbar-thumb {
                            background-color: #4b5563; 
                        }
                        .dark ::-webkit-scrollbar-track {
                            background: #1f2937; 
                        }
                        `}
                    </style>

                    <SplashScreen isVisible={isSplashVisible} />

                    <header className={`${COLORS.tertiaryBg} shadow-md p-4 fixed top-0 left-0 right-0 z-30 border-b dark:border-gray-700`}>
                        {selectedTrip ? (
                            <div className="flex justify-between items-center">
                                <h1 className="text-xl font-bold truncate">
                                    {selectedTrip.name}
                                </h1>
                                <div className="flex items-center space-x-2 space-x-reverse text-sm">
                                    <span className={COLORS.mutedText}>بودجه:</span>
                                    <span className="font-semibold text-green-600 dark:text-green-400">
                                        ${selectedTrip.budget.toFixed(2)}
                                    </span>
                                    <span className={COLORS.mutedText}>|</span>
                                    <span className={COLORS.mutedText}>خرج شده:</span>
                                    <span className={`font-semibold ${(selectedTrip.spentUSD || 0) > selectedTrip.budget ? COLORS.danger : 'text-yellow-600 dark:text-yellow-400'}`}>
                                        ${(selectedTrip.spentUSD || 0).toFixed(2)}
                                    </span>
                                </div>
                            </div>
                        ) : (
                            <h1 className="text-xl font-bold text-center text-blue-600 dark:text-blue-400">
                                مدیریت هزینه‌های سفر
                            </h1>
                        )}
                    </header>

                    <main className="main-content flex-grow overflow-y-auto">
                        {renderContent()}
                    </main>

                    <NavBar 
                        currentScreen={currentScreen} 
                        onNavigate={handleNavigate} 
                        selectedTrip={selectedTrip}
                    />

                    {/* Modals */}
                    {showModal === 'newTrip' && (
                        <NewTripDialog 
                            onClose={() => setShowModal(null)}
                            onSave={handleSaveNewTrip}
                        />
                    )}
                    {showModal === 'newExpense' && selectedTrip && (
                        <NewExpenseDialog
                            onClose={() => setShowModal(null)}
                            onSave={handleSaveNewExpense}
                            trip={selectedTrip}
                            rates={rates}
                        />
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
