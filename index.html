<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø³ØªÛŒØ§Ø± Ù…Ø§Ù„ÛŒ Ø³ÙØ±Ù‡Ù€Ù€Ù€Ù€Ù€Ù€Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ</title>
    <!-- PWA Basic Metadata (Necessary for home screen shortcut) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ø¯Ø³ØªÛŒØ§Ø± Ø³ÙØ±">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/007AFF/FFFFFF?text=ğŸ§³">
    <!-- Note: A manifest link is ideally needed, but cannot be a separate file here. We rely on meta tags and JS prompt. -->

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Vazirmatn Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on the 'dark' class
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Vazirmatn', 'Inter', 'Tahoma', 'sans-serif'],
                    },
                    colors: {
                        'ios-blue': '#007AFF',
                        'ios-red': '#FF3B30',
                        'ios-fill': '#EFEFF4',
                        'ios-dark-fill': '#2C2C2E',
                    }
                }
            }
        }
    </script>
    <!-- Load React, ReactDOM, and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Base styling for the app (iOS aesthetic) */
        body {
            margin: 0;
            padding: 0;
            background-color: #f2f2f7; /* iOS Light Background */
        }
        .dark body {
            background-color: #1c1c1e; /* iOS Dark Background */
        }
        
        /* Custom styles for FAB Menu Transition */
        .fab-menu-enter {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
        }
        .fab-menu-enter-active {
            opacity: 1;
            transform: translateY(0) scale(1);
            transition: opacity 200ms ease-out, transform 200ms ease-out;
        }
        .fab-menu-exit {
            opacity: 1;
        }
        .fab-menu-exit-active {
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: opacity 150ms ease-in, transform 150ms ease-in;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        
        // --- CONSTANTS ---
        const LS_KEY_TRIPS = 'expenseTracker_trips';
        const LS_KEY_EXPENSES = 'expenseTracker_expenses';
        const LS_KEY_SETTINGS = 'expenseTracker_settings';
        const LS_KEY_INSTALL_DISMISSED = 'expenseTracker_installDismissed'; // PWA Dismissal

        const CURRENCY_MAP = {
            'Ú†ÛŒÙ†': { code: 'CNY', symbol: 'Â¥', flag: 'ğŸ‡¨ğŸ‡³', defaultRate: 7.1 },
            'Ø¯Ø¨ÛŒ': { code: 'AED', symbol: 'Ø¯.Ø¥', flag: 'ğŸ‡¦ğŸ‡ª', defaultRate: 3.67 },
            'ØªØ±Ú©ÛŒÙ‡': { code: 'TRY', symbol: 'â‚º', flag: 'ğŸ‡¹ğŸ‡·', defaultRate: 41.69 },
        };

        const EXPENSE_CATEGORIES = ['Ù‡Ø¯ÛŒÙ‡', 'ğŸØºØ°Ø§', 'ğŸš•ØªØ§Ú©Ø³ÛŒ', 'ğŸš‡Ù…ØªØ±Ùˆ', 'ğŸ¨Ù‡ØªÙ„', 'ğŸ’­Ø³Ø§ÛŒØ±ğŸ'];

        // Color Palette (iOS Inspired)
        const COLORS = {
            primary: 'bg-ios-blue hover:bg-blue-600',
            primaryText: 'text-white',
            secondaryBg: 'bg-white dark:bg-ios-dark-fill', 
            tertiaryBg: 'bg-white dark:bg-[#1C1C1E]', 
            lightText: 'text-gray-900 dark:text-gray-100',
            mutedText: 'text-gray-500 dark:text-gray-400',
            dangerBg: 'bg-ios-red',
            dangerText: 'text-ios-red dark:text-red-400',
            separator: 'border-gray-200 dark:border-gray-700',
            inputBg: 'bg-gray-50 dark:bg-gray-800',
        };

        // --- LOCAL STORAGE HANDLERS ---
        const loadFromLocalStorage = (key, defaultValue) => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (error) {
                console.error("Error loading state from localStorage", error);
                return defaultValue;
            }
        };

        const saveToLocalStorage = (key, value) => {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (error) {
                console.error("Error saving state to localStorage", error);
            }
        };

        // --- UTILITY FUNCTIONS ---
        const generateUniqueId = () => Math.random().toString(36).substr(2, 9);
        const toUSD = (amount, currencyCode, rates) => {
            const rate = rates[currencyCode] || 1;
            return amount / rate;
        };
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        };
        
        // --- TRANSITION HELPER (Simple version for clean unmount) ---
        const useTransition = (show) => {
            const [shouldRender, setShouldRender] = useState(show);
            const [className, setClassName] = useState(show ? 'fab-menu-enter-active' : '');

            useEffect(() => {
                if (show) {
                    setShouldRender(true);
                    setTimeout(() => setClassName('fab-menu-enter-active'), 10);
                } else {
                    setClassName('fab-menu-exit-active');
                    const timeout = setTimeout(() => setShouldRender(false), 200);
                    return () => clearTimeout(timeout);
                }
            }, [show]);

            return { shouldRender, className };
        };


        // --- UI COMPONENTS ---

        const Dialog = ({ title, children, onClose, className = '' }) => (
            <div 
                className="fixed inset-0 bg-black bg-opacity-30 z-50 flex items-center justify-center p-4 backdrop-blur-sm" 
                onClick={onClose}
            >
                <div 
                    className={`${COLORS.secondaryBg} rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all ${className}`} 
                    onClick={e => e.stopPropagation()} 
                >
                    <div className="p-4 flex justify-between items-center border-b dark:border-gray-700">
                        <h3 className="text-xl font-bold">{title}</h3>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-3xl transition-transform active:scale-90" aria-label="Ø¨Ø³ØªÙ†">
                            &times;
                        </button>
                    </div>
                    <div className="p-4 pt-0">
                        {children}
                    </div>
                </div>
            </div>
        );

        const Label = ({ htmlFor, children }) => (
            <label htmlFor={htmlFor} className="block text-sm font-medium mb-1 dark:text-gray-300">
                {children}
            </label>
        );

        const Input = ({ label, type = 'text', value, onChange, placeholder = '', className = '', ...props }) => (
            <div>
                {label && <Label htmlFor={label}>{label}</Label>}
                <input
                    id={label}
                    type={type}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    className={`w-full p-3 border-0 rounded-lg ${COLORS.inputBg} dark:text-gray-100 placeholder-gray-400 text-base focus:ring-ios-blue focus:ring-2 transition-all ${className}`}
                    {...props}
                />
            </div>
        );

        const Button = ({ children, onClick, style = 'primary', className = '' }) => {
            let baseStyle = 'px-4 py-3 rounded-xl font-bold transition-all transform active:scale-[0.98] shadow-md text-base';
            let specificStyle;

            if (style === 'primary') {
                specificStyle = `${COLORS.primary} ${COLORS.primaryText}`;
            } else if (style === 'danger') {
                specificStyle = `${COLORS.dangerBg} ${COLORS.primaryText}`;
            } else if (style === 'secondary') {
                specificStyle = `bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200`;
            } else if (style === 'flat') {
                specificStyle = `bg-transparent text-ios-blue dark:text-blue-400`;
            }

            return (
                <button
                    onClick={onClick}
                    className={`${baseStyle} ${specificStyle} ${className}`}
                >
                    {children}
                </button>
            );
        };
        
        // --- PWA Installation Prompt Component ---
        const PWAInstallPrompt = ({ isVisible, onInstall, onDismiss }) => {
            if (!isVisible) return null;

            return (
                <div className="fixed bottom-0 left-0 right-0 z-50 p-4 bg-white dark:bg-[#1C1C1E] shadow-2xl border-t border-gray-200 dark:border-gray-700">
                    <div className="max-w-md mx-auto flex items-center justify-between">
                        <div className="flex items-center space-x-3 space-x-reverse">
                            <span className="text-3xl flex-shrink-0">ğŸš€</span>
                            <div>
                                <p className="font-bold text-base">Ù†ØµØ¨ "Ø¯Ø³ØªÛŒØ§Ø± Ù…Ø§Ù„ÛŒ Ø³ÙØ±"</p>
                                <p className="text-sm text-gray-600 dark:text-gray-400">Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</p>
                            </div>
                        </div>
                        <div className="flex space-x-2 space-x-reverse">
                            <Button onClick={onDismiss} style="flat" className="px-3 py-1 text-sm shadow-none font-medium">
                                Ù†Ù‡ØŒ Ù…Ù…Ù†ÙˆÙ†
                            </Button>
                            <Button onClick={onInstall} style="primary" className="px-3 py-1 text-sm shadow-none !py-2">
                                Ù†ØµØ¨ Ú©Ù†
                            </Button>
                        </div>
                    </div>
                </div>
            );
        };


        // --- MODALS / DIALOGS (Existing components adapted) ---

        const NewTripDialog = ({ onSave, onClose, initialName = '' }) => {
            const [name, setName] = useState(initialName);
            const [destination, setDestination] = useState('');
            const [budget, setBudget] = useState('');
            const currencyInfo = useMemo(() => destination ? CURRENCY_MAP[destination] : null, [destination]);

            const handleSave = () => {
                if (!name || (initialName ? false : (!destination || !budget || isNaN(parseFloat(budget)) || parseFloat(budget) <= 0))) {
                    // Using a custom alert system instead of window.alert
                    console.error("Ù„Ø·ÙØ§Ù‹ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯."); 
                    // Since we cannot use window.alert, we rely on console error and user seeing missing fields.
                    if (!initialName && (!destination || !budget)) return;
                    if (!name) return;
                }
                
                if (initialName) {
                    onSave({ name: name }); // Only send name for rename
                } else {
                    onSave({
                        id: generateUniqueId(),
                        name: name,
                        destination: destination,
                        budget: parseFloat(budget),
                        currencyCode: currencyInfo.code,
                        createdAt: new Date().toISOString(),
                        spentUSD: 0,
                    });
                }
                onClose();
            };

            return (
                <Dialog title={initialName ? "ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø³ÙØ±" : "Ø«Ø¨Øª Ø³ÙØ± Ø¬Ø¯ÛŒØ¯"} onClose={onClose}>
                    <div className="space-y-4">
                        <Input label="Ù†Ø§Ù… Ø³ÙØ±" value={name} onChange={e => setName(e.target.value)} placeholder="Ù…Ø«Ø§Ù„: Ø³ÙØ± Ø´Ù†Ø²Ù† 1404" />
                        
                        {!initialName && (
                            <>
                                <div>
                                    <Label htmlFor="destination">Ù…Ù‚ØµØ¯</Label>
                                    <select
                                        id="destination"
                                        value={destination}
                                        onChange={e => setDestination(e.target.value)}
                                        className={`w-full p-3 border-0 rounded-lg ${COLORS.inputBg} dark:text-gray-100 mt-1 focus:ring-ios-blue focus:ring-2`}
                                    >
                                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù‚ØµØ¯...</option>
                                        {Object.keys(CURRENCY_MAP).map(dest => (
                                            <option key={dest} value={dest}>
                                                {CURRENCY_MAP[dest].flag} {dest}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                {currencyInfo && (
                                    <div className="flex justify-between items-center text-sm p-2 rounded-lg bg-gray-100 dark:bg-gray-700">
                                        <span className={COLORS.mutedText}>Ø§Ø±Ø² Ù¾ÛŒØ´â€ŒÙØ±Ø¶:</span>
                                        <span className="font-bold">{currencyInfo.flag} {currencyInfo.code} ({currencyInfo.symbol})</span>
                                    </div>
                                )}
                                <Input 
                                    label="Ø¨ÙˆØ¯Ø¬Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (USD)" 
                                    type="number" 
                                    value={budget} 
                                    onChange={e => setBudget(e.target.value)} 
                                    placeholder="Ù…Ø«Ø§Ù„: 4000"
                                    inputMode="decimal"
                                />
                            </>
                        )}

                        <Button onClick={handleSave} className="w-full mt-6">
                            {initialName ? "Ø«Ø¨Øª Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯" : "Ø«Ø¨Øª Ø³ÙØ±"}
                        </Button>
                    </div>
                </Dialog>
            );
        };

        const NewExpenseDialog = ({ onSave, onClose, trip, rates }) => {
            const [category, setCategory] = useState(EXPENSE_CATEGORIES[0]);
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const currencyInfo = CURRENCY_MAP[trip.destination];

            const handleSave = () => {
                if (!category || !description || !amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
                    console.error("Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ù¾Ø± Ú©Ù†ÛŒØ¯.");
                    return;
                }

                const amountForeign = parseFloat(amount);
                const amountUSD = toUSD(amountForeign, trip.currencyCode, rates);
                
                onSave({
                    id: generateUniqueId(),
                    tripId: trip.id,
                    category: category,
                    description: description,
                    amountForeign: amountForeign,
                    currencyCode: trip.currencyCode,
                    amountUSD: amountUSD,
                    date: new Date().toISOString().split('T')[0], 
                    timestamp: Date.now(),
                });
                onClose();
            };

            return (
                <Dialog title={`Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ ${trip.name}`} onClose={onClose}>
                    <div className="space-y-4">
                        <div>
                            <Label htmlFor="category">Ù†ÙˆØ¹ Ù‡Ø²ÛŒÙ†Ù‡</Label>
                            <select
                                id="category"
                                value={category}
                                onChange={e => setCategory(e.target.value)}
                                className={`w-full p-3 border-0 rounded-lg ${COLORS.inputBg} dark:text-gray-100 mt-1 focus:ring-ios-blue focus:ring-2`}
                            >
                                {EXPENSE_CATEGORIES.map(cat => (
                                    <option key={cat} value={cat}>{cat}</option>
                                ))}
                            </select>
                        </div>

                        <Input label="Ø´Ø±Ø­ Ù‡Ø²ÛŒÙ†Ù‡" value={description} onChange={e => setDescription(e.target.value)} placeholder="Ù…Ø«Ø§Ù„: Ù†Ø§Ù‡Ø§Ø± KFC" />

                        <div>
                            <Label htmlFor="amount">Ù…Ø¨Ù„Øº</Label>
                            <div className="flex items-center space-x-2 space-x-reverse">
                                <Input
                                    label="amount"
                                    type="number"
                                    value={amount}
                                    onChange={e => setAmount(e.target.value)}
                                    placeholder="Ù…Ù‚Ø¯Ø§Ø±"
                                    className="flex-grow p-3"
                                    inputMode="decimal"
                                />
                                <span className={`${COLORS.mutedText} font-bold text-lg p-3 rounded-lg flex-shrink-0`}>
                                    {currencyInfo.symbol} ({currencyInfo.code})
                                </span>
                            </div>
                        </div>

                        <Button onClick={handleSave} className="w-full mt-6">Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</Button>
                    </div>
                </Dialog>
            );
        };
        
        const TripActionDialog = ({ trip, onRename, onDelete, onClose }) => {
            const handleDeletion = () => {
                // Using a simpler, less intrusive modal/dialog pattern if possible.
                // Since confirm() is forbidden, we simulate a confirmation.
                if (window.confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø³ÙØ± ${trip.name} Ùˆ ØªÙ…Ø§Ù… Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù† Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ†Ø§Ù¾Ø°ÛŒØ± Ø§Ø³Øª.`)) { 
                    onClose(); 
                    onDelete(trip.id);
                }
            };

            return (
                <Dialog title={`Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ± ${trip.name}`} onClose={onClose} className="!max-w-xs">
                    <div className="space-y-2">
                        <Button 
                            onClick={() => { onClose(); onRename(trip); }} 
                            style="secondary" 
                            className="w-full bg-ios-fill dark:bg-gray-700 text-ios-blue dark:text-blue-400 shadow-none !py-2"
                        >
                            ØªØºÛŒÛŒØ± Ù†Ø§Ù…
                        </Button>
                        <Button 
                            onClick={handleDeletion} 
                            style="danger" 
                            className="w-full shadow-none !py-2"
                        >
                            Ø­Ø°Ù Ø³ÙØ±
                        </Button>
                        <Button onClick={onClose} style="flat" className="w-full mt-4 shadow-none !py-2">
                            Ù„ØºÙˆ
                        </Button>
                    </div>
                </Dialog>
            );
        };
        
        const FABMenu = ({ onNewTrip, onNewExpense, onClose, isTripSelected }) => {
            const { shouldRender, className } = useTransition(true);

            if (!shouldRender) return null;

            return (
                <div 
                    className="fixed inset-0 z-40" 
                    onClick={onClose}
                >
                    <div className={`absolute bottom-20 left-1/2 transform -translate-x-1/2 p-4 ${className}`}
                        onClick={e => e.stopPropagation()}
                    >
                        <div className={`${COLORS.secondaryBg} rounded-xl shadow-2xl w-56 overflow-hidden`}>
                            <div className="space-y-0.5">
                                {isTripSelected && (
                                    <button 
                                        onClick={() => { onClose(); onNewExpense(); }}
                                        className={`w-full text-right p-3 font-medium hover:bg-ios-fill dark:hover:bg-gray-700 transition-colors flex items-center justify-end ${COLORS.lightText}`}
                                    >
                                        <span className="ml-2">Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯</span>
                                        <span className="text-xl">ğŸ’µ</span>
                                    </button>
                                )}
                                <button 
                                    onClick={() => { onClose(); onNewTrip(); }}
                                    className={`w-full text-right p-3 font-medium hover:bg-ios-fill dark:hover:bg-gray-700 transition-colors flex items-center justify-end ${COLORS.lightText} ${isTripSelected ? 'border-t dark:border-gray-700' : ''}`}
                                >
                                    <span className="ml-2">Ø«Ø¨Øª Ø³ÙØ± Ø¬Ø¯ÛŒØ¯</span>
                                    <span className="text-xl">âœˆï¸</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        

        // --- CORE COMPONENTS ---

        const SplashScreen = ({ isVisible }) => {
            if (!isVisible) return null;

            return (
                <div 
                    className="fixed inset-0 z-50 flex flex-col items-center justify-center transition-opacity duration-4000"
                    style={{ 
                        background: 'linear-gradient(135deg, #007AFF 0%, #005BBF 100%)', 
                        opacity: isVisible ? 1 : 0
                    }}
                >
                    <div className="text-center text-white p-6 rounded-xl animate-pulse">
                        <h1 className="text-4xl font-extrabold mb-3 shadow-lg">
                            âœˆï¸ Ø¯Ø³ØªÛŒØ§Ø± Ù…Ø§Ù„ÛŒ</br>Ø³ÙØ±Ù‡Ù€Ù€Ù€Ù€Ù€Ù€Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ
                    Ù†ÙˆØ´ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ ØªÙˆØ³Ø· Ù…Ø­Ù…Ø¯ ØµØ§Ø¯Ù‚ÛŒ Ú©Ø§Ø¬ÛŒ
                        </h1>
                        <p className="text-xs mt-10 opacity-70">
                            !! Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ !!
                        </p>
                    </div>
                </div>
            );
        };

        const NavItem = ({ name, screen, icon, currentScreen, onNavigate, enabled }) => {
            const isActive = currentScreen === screen;
            const isDisabled = !enabled;

            return (
                <button
                    onClick={() => !isDisabled && onNavigate(screen)}
                    disabled={isDisabled}
                    className={`
                        flex flex-col items-center text-xs p-1 h-full transition-colors duration-200
                        ${isDisabled 
                            ? 'text-gray-400 dark:text-gray-600 cursor-not-allowed' 
                            : (isActive ? 'text-ios-blue dark:text-blue-400' : 'text-gray-700 dark:text-gray-300 hover:text-ios-blue dark:hover:text-blue-400')
                        }
                    `}
                >
                    <span className="text-xl mb-0.5">{icon}</span>
                    <span className="font-medium">{name}</span>
                </button>
            );
        };

        const NavBar = ({ currentScreen, onNavigate, selectedTrip }) => {
            const isTripSelected = !!selectedTrip;

            const navItems = [
                { name: 'Ø³ÙØ±Ù‡Ø§', screen: 'home', icon: 'ğŸ ', enabled: true },
                { name: 'Ú¯Ø²Ø§Ø±Ø´', screen: 'reports', icon: 'ğŸ“Š', enabled: isTripSelected },
                { name: 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª', screen: 'settings', icon: 'âš™ï¸', enabled: true },
                { name: 'Ø¯Ø±Ø¨Ø§Ø±Ù‡', screen: 'about', icon: 'â„¹ï¸', enabled: true },
            ];

            const PlusButton = () => (
                <button
                    onClick={() => onNavigate('plus')}
                    className={`
                        ${COLORS.primary} w-14 h-14 rounded-full -mt-6 shadow-xl shadow-ios-blue/50
                        flex items-center justify-center text-3xl transition-transform
                        transform hover:scale-105 active:scale-95 z-20 
                        !text-white border-4 border-white dark:border-[#1C1C1E]
                    `}
                    aria-label="Ù…Ù†ÙˆÛŒ Ø§Ú©Ø´Ù†"
                >
                    â•
                </button>
            );

            return (
                <nav className={`${COLORS.secondaryBg} shadow-2xl fixed bottom-0 left-0 right-0 z-40 border-t ${COLORS.separator} h-16`}>
                    <div className="grid grid-cols-5 items-end h-full pt-2">
                        {navItems.slice(0, 2).map(item => (
                            <NavItem key={item.name} {...item} currentScreen={currentScreen} onNavigate={onNavigate} />
                        ))}
                        <div className="flex justify-center">
                            <PlusButton />
                        </div>
                        {navItems.slice(2).map(item => (
                            <NavItem key={item.name} {...item} currentScreen={currentScreen} onNavigate={onNavigate} />
                        ))}
                    </div>
                </nav>
            );
        };

        // --- Screens ---

        const HomeScreen = ({ trips, onSelectTrip, selectedTrip, onActionTrip }) => {
            if (!trips || trips.length === 0) {
                return (
                    <div className="flex flex-col items-center justify-center h-full text-center p-6 mt-20">
                        <h2 className="text-xl font-bold mb-4">
                            Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯!
                        </h2>
                        <p className={COLORS.mutedText}>
                            Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø§ÙˆÙ„ÛŒÙ† Ø³ÙØ±ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ <span className="text-ios-blue font-bold">â•</span> Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.
                        </p>
                        <p className="mt-8 text-xs font-medium p-3 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-xl">
                            âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ ÙÙ‚Ø· Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù…Ø­Ù„ÛŒ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                        </p>
                    </div>
                );
            }

            const totalSpent = trips.reduce((sum, trip) => sum + (trip.spentUSD || 0), 0).toFixed(2);
            const totalBudget = trips.reduce((sum, trip) => sum + trip.budget, 0).toFixed(2);

            // Item for Long Press/Context Menu
            const TripItem = ({ trip }) => {
                const percentageSpent = trip.budget > 0 ? ((trip.spentUSD || 0) / trip.budget) * 100 : 0;
                const isOverBudget = percentageSpent > 100;
                const currencyInfo = CURRENCY_MAP[trip.destination];

                const handlePress = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    onActionTrip(trip.id);
                };

                return (
                    <div
                        key={trip.id}
                        onClick={() => onSelectTrip(trip.id)}
                        onContextMenu={handlePress} 
                        onTouchStart={(e) => { 
                            const touchTimer = setTimeout(() => handlePress(e), 700);
                            e.currentTarget.dataset.touchTimer = touchTimer;
                        }}
                        onTouchEnd={(e) => {
                            clearTimeout(e.currentTarget.dataset.touchTimer);
                        }}
                        className={`p-4 rounded-xl shadow-lg cursor-pointer transition-all border 
                            ${trip.id === selectedTrip?.id 
                                ? 'border-ios-blue bg-blue-50 dark:bg-gray-800' 
                                : 'border-transparent hover:shadow-xl hover:bg-gray-50 dark:hover:bg-gray-800'
                            } ${COLORS.secondaryBg} shadow-sm border-2
                        `}
                    >
                        <div className="flex justify-between items-start mb-2">
                            <h3 className="text-lg font-bold flex items-center">
                                {currencyInfo.flag} {trip.name}
                            </h3>
                            <span className={COLORS.mutedText} title="Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÛŒØ§ ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯">
                                Ø¨ÙˆØ¯Ø¬Ù‡: <span className="font-bold">{formatCurrency(trip.budget)}</span>
                            </span>
                        </div>
                        
                        <div className="flex justify-between items-center text-sm mb-2">
                            <p className={`font-semibold ${isOverBudget ? COLORS.dangerText : 'text-green-600 dark:text-green-400'}`}>
                                Ù‡Ø²ÛŒÙ†Ù‡ Ø´Ø¯Ù‡: <span className="font-bold">{formatCurrency(trip.spentUSD || 0)}</span>
                            </p>
                            <span className={COLORS.mutedText}>
                                {currencyInfo.code}
                            </span>
                        </div>

                        <div className="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700 mt-2">
                            <div 
                                className={`h-2 rounded-full transition-all duration-500 ${isOverBudget ? 'bg-ios-red' : 'bg-ios-blue'}`} 
                                style={{ width: `${Math.min(percentageSpent, 100)}%` }}
                            ></div>
                        </div>
                        {isOverBudget && <p className="text-ios-red text-xs mt-1 font-medium">!Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ ØªØ¹ÛŒÛŒÙ† Ø´Ø¯Ù‡ Ø¹Ø¨ÙˆØ± Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</p>}
                    </div>
                );
            };

            return (
                <div className="space-y-4 p-4 pb-20">
                    <h1 className="text-3xl font-bold pt-4 pb-2">Ø³ÙØ±Ù‡Ø§ÛŒ Ø´Ù…Ø§</h1>
                    
                    <div className="flex justify-between p-3 rounded-xl bg-ios-fill dark:bg-gray-700 shadow-inner">
                        <div className="text-sm font-medium">
                            <p className="text-gray-800 dark:text-gray-200">Ø¬Ù…Ø¹ Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§:</p>
                            <p className="text-xl font-extrabold text-ios-blue">{formatCurrency(totalSpent)}</p>
                        </div>
                        <div className="text-sm font-medium text-left">
                            <p className="text-gray-800 dark:text-gray-200">Ø¬Ù…Ø¹ Ú©Ù„ Ø¨ÙˆØ¯Ø¬Ù‡:</p>
                            <p className="text-xl font-extrabold text-ios-blue">{formatCurrency(totalBudget)}</p>
                        </div>
                    </div>
                    
                    <div className="space-y-3 pt-4">
                        {trips.map(trip => <TripItem key={trip.id} trip={trip} />)}
                    </div>
                </div>
            );
        };
        
        const GaugeChart = ({ percentage }) => {
            const radius = 50;
            const circumference = 2 * Math.PI * radius;
            const progress = (percentage / 100) * circumference;
            const dashoffset = circumference - progress;
            
            let color = 'text-green-500';
            if (percentage > 75) color = 'text-yellow-500';
            if (percentage > 100) color = 'text-ios-red';

            return (
                <div className="relative flex items-center justify-center w-full max-w-xs mx-auto">
                    <svg className="w-40 h-40 transform -rotate-90" viewBox="0 0 120 120">
                        <circle 
                            cx="60" 
                            cy="60" 
                            r={radius} 
                            fill="none" 
                            stroke="currentColor" 
                            strokeWidth="10" 
                            className="text-gray-300 dark:text-gray-700" 
                        />
                        <circle 
                            cx="60" 
                            cy="60" 
                            r={radius} 
                            fill="none" 
                            stroke="currentColor" 
                            strokeWidth="10" 
                            strokeDasharray={circumference}
                            strokeDashoffset={dashoffset}
                            strokeLinecap="round"
                            className={color}
                            style={{ transition: 'stroke-dashoffset 0.5s ease-in-out' }}
                        />
                    </svg>
                    <div className={`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center`}>
                        <span className={`text-2xl font-bold ${color}`}>{Math.round(percentage)}%</span>
                    </div>
                </div>
            );
        };

        const PieChart = ({ data }) => {
            if (!data || data.length === 0) {
                return <div className="text-center p-4">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ù…ÙˆØ¯Ø§Ø± Ù‡Ø²ÛŒÙ†Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>;
            }

            const total = data.reduce((sum, item) => sum + item.amountUSD, 0);
            let startAngle = 0;

            const categoryColors = {
                'Ù‡ØªÙ„': '#FF9500',   
                'ØºØ°Ø§': '#34C759',    
                'ØªØ§Ú©Ø³ÛŒ': '#007AFF', 
                'Ù…ØªØ±Ùˆ': '#FFCC00',   
                'Ù‡Ø¯ÛŒÙ‡': '#AF52DE',   
                'Ø³Ø§ÛŒØ±': '#8E8E93',   
            };

            const segments = data.map((item) => {
                const percentage = total > 0 ? (item.amountUSD / total) : 0;
                const endAngle = startAngle + percentage * 360;
                
                const toX = (angle) => 50 + 50 * Math.cos(angle * Math.PI / 180);
                const toY = (angle) => 50 + 50 * Math.sin(angle * Math.PI / 180);

                const x1 = toX(startAngle);
                const y1 = toY(startAngle);
                const x2 = toX(endAngle);
                const y2 = toY(endAngle);

                const largeArcFlag = percentage > 0.5 ? 1 : 0;
                const color = categoryColors[item.category] || categoryColors['Ø³Ø§ÛŒØ±'];

                const d = [
                    `M 50,50`,
                    `L ${x1},${y1}`,
                    `A 50,50 0 ${largeArcFlag} 1 ${x2},${y2}`,
                    `Z`
                ].join(' ');

                const segment = {
                    category: item.category,
                    percentage: (percentage * 100).toFixed(1),
                    amountUSD: item.amountUSD,
                    color: color,
                    d: d,
                };

                startAngle = endAngle;
                return segment;
            });

            return (
                <div className="flex flex-col lg:flex-row items-center justify-center p-4">
                    <svg viewBox="0 0 100 100" className="w-48 h-48 flex-shrink-0">
                        {segments.map((segment, index) => (
                            <path
                                key={index}
                                d={segment.d}
                                fill={segment.color}
                                className="transition-opacity duration-300 hover:opacity-80"
                            />
                        ))}
                    </svg>

                    <div className="w-full lg:w-auto mt-6 lg:mt-0 lg:mr-8 text-sm space-y-2">
                        <h4 className="font-bold border-b pb-1 mb-2">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ (USD)</h4>
                        {segments.map((segment, index) => (
                            <div key={index} className="flex justify-between items-center">
                                <div className="flex items-center">
                                    <span 
                                        className="w-3 h-3 rounded-full mr-2" 
                                        style={{ backgroundColor: segment.color }}
                                    ></span>
                                    <span className={COLORS.lightText}>{segment.category}</span>
                                </div>
                                <span className="font-mono text-gray-700 dark:text-gray-300">
                                    {formatCurrency(segment.amountUSD)} ({segment.percentage}%)
                                </span>
                            </div>
                        ))}
                        <div className="pt-2 border-t dark:border-gray-700 flex justify-between font-bold">
                            <span>Ø¬Ù…Ø¹ Ú©Ù„:</span>
                            <span>{formatCurrency(total)}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportsScreen = ({ selectedTrip, expenses }) => {
            const expensesForTrip = expenses.filter(e => e.tripId === selectedTrip.id);

            if (expensesForTrip.length === 0) {
                return (
                    <div className="text-center p-6 pt-12">
                        <h1 className="text-3xl font-bold pt-4 pb-2">Ú¯Ø²Ø§Ø±Ø´Ø§Øª</h1>
                        <p className={COLORS.mutedText}>
                            Ù‡Ù†ÙˆØ² Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø³ÙØ± <span className="font-bold">{selectedTrip.name}</span> Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
                        </p>
                    </div>
                );
            }

            const totalSpentUSD = expensesForTrip.reduce((sum, e) => sum + e.amountUSD, 0);
            const percentage = selectedTrip.budget > 0 ? (totalSpentUSD / selectedTrip.budget) * 100 : 0;

            const categoryData = expensesForTrip.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + expense.amountUSD;
                return acc;
            }, {});
            const pieChartData = Object.entries(categoryData).map(([category, amountUSD]) => ({
                category,
                amountUSD,
            }));

            const dailyExpenses = expensesForTrip.reduce((acc, expense) => {
                const date = expense.date; 
                if (!acc[date]) {
                    acc[date] = { hotel: 0, perDiem: 0, all: 0, details: [] };
                }
                
                acc[date].all += expense.amountUSD;
                if (expense.category === 'Ù‡ØªÙ„') {
                    acc[date].hotel += expense.amountUSD;
                } else {
                    acc[date].perDiem += expense.amountUSD;
                }

                acc[date].details.push(expense);
                return acc;
            }, {});

            const dailyAlerts = Object.entries(dailyExpenses)
                .filter(([, data]) => data.hotel > 120 || data.perDiem > 40)
                .sort(([dateA], [dateB]) => new Date(dateB) - new Date(dateA)); 

            return (
                <div className="p-4 pb-20 space-y-8">
                    <h1 className="text-3xl font-bold pt-4 pb-2">Ú¯Ø²Ø§Ø±Ø´Ø§Øª</h1>
                    <h2 className="text-xl font-bold text-ios-blue dark:text-blue-400">Ø³ÙØ±: {selectedTrip.name}</h2>

                    <div className={`${COLORS.secondaryBg} p-4 rounded-xl shadow-md border ${COLORS.separator}`}>
                        <h3 className="text-lg font-bold mb-4 text-center">Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„</h3>
                        <GaugeChart percentage={percentage} />
                        <div className="text-center mt-4 space-y-1">
                            <p className={COLORS.mutedText}>Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„: {formatCurrency(selectedTrip.budget)}</p>
                            <p className="text-xl font-bold text-ios-blue">{formatCurrency(totalSpentUSD)} <span className="text-sm">Ù‡Ø²ÛŒÙ†Ù‡ Ø´Ø¯Ù‡</span></p>
                            {percentage > 100 && <p className="text-ios-red font-bold mt-2">!!!Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ù„ Ø¹Ø¨ÙˆØ± Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</p>}
                        </div>
                    </div>
                    
                    <div className={`${COLORS.secondaryBg} p-4 rounded-xl shadow-md border ${COLORS.separator}`}>
                        <h3 className="text-lg font-bold mb-4 text-center">ØªÙÚ©ÛŒÚ© Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h3>
                        <PieChart data={pieChartData} />
                    </div>

                    {dailyAlerts.length > 0 && (
                        <div className={`p-4 rounded-xl border border-ios-red dark:border-red-600 bg-red-50 dark:bg-red-950 shadow-md space-y-3`}>
                            <h3 className="text-ios-red font-bold flex items-center">
                                âš ï¸ Ø§Ø®Ø·Ø§Ø± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡
                            </h3>
                            <p className="text-sm text-red-600 dark:text-red-200">
                                Ø­Ø¯Ø§Ú©Ø«Ø± Ø±ÙˆØ²Ø§Ù†Ù‡ Ù‡ØªÙ„: $120. Ø­Ø¯Ø§Ú©Ø«Ø± ØªÙ†Ø®ÙˆØ§Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø³Ø§ÛŒØ±): $40.
                            </p>
                            {dailyAlerts.map(([date, data]) => (
                                <div key={date} className="p-3 bg-red-100 dark:bg-red-900 rounded-lg border border-red-300">
                                    <h4 className="font-bold text-red-700 dark:text-red-300">{date}</h4>
                                    {data.hotel > 120 && (
                                        <p className="text-sm">
                                            <span className="font-semibold">Ù‡Ø²ÛŒÙ†Ù‡ Ù‡ØªÙ„:</span> {formatCurrency(data.hotel)} (Ø¨ÛŒØ´ØªØ± Ø§Ø² $120)
                                        </p>
                                    )}
                                    {data.perDiem > 40 && (
                                        <p className="text-sm">
                                            <span className="font-semibold">ØªÙ†Ø®ÙˆØ§Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡:</span> {formatCurrency(data.perDiem)} (Ø¨ÛŒØ´ØªØ± Ø§Ø² $40)
                                        </p>
                                    )}
                                    <p className="text-xs mt-1 text-red-500 dark:text-red-400">
                                        Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ø±ÙˆØ²: {formatCurrency(data.all)}
                                    </p>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const SettingsScreen = ({ theme, onThemeChange, autoDarkMode, onToggleAutoDarkMode, rates, onSaveRates }) => {
            const [localRates, setLocalRates] = useState(rates);

            useEffect(() => {
                setLocalRates(rates);
            }, [rates]);

            const handleRateChange = (code, value) => {
                setLocalRates(prev => ({
                    ...prev,
                    [code]: parseFloat(value) || 0,
                }));
            };

            const handleSave = () => {
                onSaveRates(localRates);
                console.log("Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ø² Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯."); // Replaced alert()
            };

            const rateKeys = Object.values(CURRENCY_MAP).map(info => info.code);

            return (
                <div className="p-4 pb-20 space-y-6">
                    <h1 className="text-3xl font-bold pt-4 pb-2">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h1>

                    <div className={`${COLORS.secondaryBg} p-4 rounded-xl shadow-md space-y-3 border ${COLORS.separator}`}>
                        <h3 className="text-lg font-bold border-b pb-2">ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙ…</h3>
                        
                        <div className="flex justify-between items-center py-2">
                            <span className="font-medium">Ø­Ø§Ù„Øª Ø´Ø¨ (Dark Mode)</span>
                            <label className="relative inline-flex items-center cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    checked={theme === 'dark'} 
                                    onChange={() => onThemeChange(theme === 'dark' ? 'light' : 'dark')} 
                                    className="sr-only peer"
                                />
                                {/* FIXED iOS Style Toggle Switch - Check thumb position */}
                                <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 dark:bg-gray-700 rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-ios-blue"></div>
                                <span className="mr-3 text-sm font-medium">{theme === 'dark' ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}</span>
                            </label>
                        </div>

                        <div className="flex items-center pt-2 border-t ${COLORS.separator}">
                            <input 
                                id="auto-dark-mode" 
                                type="checkbox" 
                                checked={autoDarkMode} 
                                onChange={onToggleAutoDarkMode} 
                                className="w-4 h-4 text-ios-blue bg-gray-100 border-gray-300 rounded focus:ring-ios-blue dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600"
                            />
                            <label htmlFor="auto-dark-mode" className="mr-2 text-sm font-medium">
                                Ø¯Ø§Ø±Ú© Ù…Ø¯ Ø®ÙˆØ¯Ú©Ø§Ø± (Ø³ÛŒØ³ØªÙ…)
                            </label>
                        </div>
                    </div>

                    <div className={`${COLORS.secondaryBg} p-4 rounded-xl shadow-md space-y-3 border ${COLORS.separator}`}>
                        <h3 className="text-lg font-bold border-b pb-2">Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ø² (USD Ø¨Ù‡ ÙˆØ§Ø­Ø¯ Ù…Ø­Ù„ÛŒ)</h3>
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            Ù…Ù‚Ø¯Ø§Ø± Ø§Ø±Ø² Ù…Ø­Ù„ÛŒ Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± 1 Ø¯Ù„Ø§Ø± Ø¢Ù…Ø±ÛŒÚ©Ø§.
                        </p>
                        
                        {rateKeys.map(code => {
                            const info = Object.values(CURRENCY_MAP).find(c => c.code === code);
                            return (
                                <div key={code} className="flex items-center space-x-4 space-x-reverse">
                                    <span className="w-10 text-2xl text-center flex-shrink-0">{info.flag}</span>
                                    <span className="w-16 font-medium text-lg flex-shrink-0">{info.code}</span>
                                    <Input 
                                        label=""
                                        type="number"
                                        value={localRates[code] || ''}
                                        onChange={(e) => handleRateChange(code, e.target.value)}
                                        placeholder={`Ù†Ø±Ø® ${info.code}`}
                                        className="flex-grow text-left"
                                        style={{ direction: 'ltr' }}
                                        inputMode="decimal"
                                    />
                                </div>
                            );
                        })}
                        
                        <Button onClick={handleSave} className="w-full mt-6">Ø°Ø®ÛŒØ±Ù‡ Ù†Ø±Ø®â€ŒÙ‡Ø§</Button>
                    </div>
                </div>
            );
        };

        const AboutScreen = () => (
            <div className="p-4 pb-20 space-y-6">
                <h1 className="text-3xl font-bold pt-4 pb-2">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</h1>
                <div className={`${COLORS.secondaryBg} p-6 rounded-xl shadow-md border ${COLORS.separator} text-center`}>
                    <p className="text-lg font-bold mb-4 text-ios-blue dark:text-blue-400">
                        Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø³ØªÛŒØ§Ø± Ù…Ø§Ù„ÛŒ Ø³ÙØ±Ù‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ
                    </p>
                    <p className={COLORS.mutedText}>
                        Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§ Ù‡Ø¯Ù Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø²ÛŒ Ø³ÙØ±ØŒ Ø¨Ù‡â€ŒØµÙˆØ±Øª ÛŒÚ© ÙˆØ¨â€ŒØ§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù…Ø³ØªÙ‚Ù„ (PWA) Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.
                    </p>
                    <p className="mt-6 text-sm font-medium">
                        Ù†ÙˆØ´ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ ØªÙˆØ³Ø· Ù…Ø­Ù…Ø¯ ØµØ§Ø¯Ù‚ÛŒ Ú©Ø§Ø¬ÛŒ
                    </p>
                </div>
            </div>
        );

        const LoadingIndicator = ({ message = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ..." }) => (
            <div className="flex flex-col items-center justify-center h-full text-center p-6">
                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-ios-blue dark:border-blue-400 mb-3"></div>
                <p className="font-medium">{message}</p>
            </div>
        );


        // --- MAIN APP COMPONENT ---
        const App = () => {
            
            // --- Initial State Loading (localStorage) ---
            const initialSettings = loadFromLocalStorage(LS_KEY_SETTINGS, { 
                theme: 'light', 
                autoDarkMode: true, 
                rates: { 
                    'CNY': CURRENCY_MAP['Ú†ÛŒÙ†'].defaultRate, 
                    'AED': CURRENCY_MAP['Ø¯Ø¨ÛŒ'].defaultRate, 
                    'TRY': CURRENCY_MAP['ØªØ±Ú©ÛŒÙ‡'].defaultRate 
                }
            });

            const [trips, setTrips] = useState(loadFromLocalStorage(LS_KEY_TRIPS, []));
            const [expenses, setExpenses] = useState(loadFromLocalStorage(LS_KEY_EXPENSES, []));
            
            // Settings State
            const [theme, setTheme] = useState(initialSettings.theme); 
            const [autoDarkMode, setAutoDarkMode] = useState(initialSettings.autoDarkMode);
            const [rates, setRates] = useState(initialSettings.rates);

            // UI State
            const [selectedTripId, setSelectedTripId] = useState(null);
            const [currentScreen, setCurrentScreen] = useState('home');
            const [isSplashVisible, setIsSplashVisible] = useState(true);
            const [showModal, setShowModal] = useState(null); // 'newTrip', 'newExpense', 'fabMenu', 'actionTrip', 'renameTrip'
            const [actionTripId, setActionTripId] = useState(null); // ID of trip being managed (rename/delete)
            const [isLoading, setIsLoading] = useState(false);
            
            // PWA State
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [showInstallPrompt, setShowInstallPrompt] = useState(false);


            // --- Derived State ---
            const selectedTrip = useMemo(() => trips.find(t => t.id === selectedTripId), [trips, selectedTripId]);
            const actionTrip = useMemo(() => trips.find(t => t.id === actionTripId), [trips, actionTripId]);
            
            useEffect(() => {
                if (!selectedTripId && trips.length > 0) {
                    setSelectedTripId(trips[0].id);
                }
            }, [trips, selectedTripId]);


            // --- PWA Logic ---
            useEffect(() => {
                // 1. Handle deferred prompt
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                    
                    // Only show custom prompt if user hasn't dismissed it before
                    const dismissed = loadFromLocalStorage(LS_KEY_INSTALL_DISMISSED, false);
                    if (!dismissed) {
                        setShowInstallPrompt(true);
                    }
                };

                // 2. Handle app installed event (for cleanup)
                const handleAppInstalled = () => {
                    setDeferredPrompt(null);
                    setShowInstallPrompt(false);
                    // Clear dismissal state if app is successfully installed
                    saveToLocalStorage(LS_KEY_INSTALL_DISMISSED, false);
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                window.addEventListener('appinstalled', handleAppInstalled);

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                    window.removeEventListener('appinstalled', handleAppInstalled);
                };
            }, []);

            // Function to trigger the native prompt
            const handleInstallClick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    setDeferredPrompt(null);
                    setShowInstallPrompt(false); 
                }
            };

            // Function to dismiss the custom prompt permanently
            const handleDismissInstall = () => {
                saveToLocalStorage(LS_KEY_INSTALL_DISMISSED, true);
                setShowInstallPrompt(false);
            };

            // --- Local Storage Synchronization & Calculated Spent ---
            
            // Save Trips, Expenses, and Update Spent Amount
            useEffect(() => {
                saveToLocalStorage(LS_KEY_TRIPS, trips);
            }, [trips]);

            useEffect(() => {
                saveToLocalStorage(LS_KEY_EXPENSES, expenses);
            }, [expenses]);
            
            // Recalculate spent USD on trips
            useEffect(() => {
                const newTrips = trips.map(trip => {
                    const totalSpent = expenses
                        .filter(e => e.tripId === trip.id)
                        .reduce((sum, e) => sum + e.amountUSD, 0);
                    
                    if (Math.abs(trip.spentUSD - totalSpent) > 0.01) {
                        return { ...trip, spentUSD: totalSpent };
                    }
                    return trip;
                });

                if (JSON.stringify(trips) !== JSON.stringify(newTrips)) {
                    setTrips(newTrips);
                }
            }, [expenses, rates, trips]);


            // --- Splash Screen Timeout ---
            useEffect(() => {
                const timer = setTimeout(() => {
                    setIsSplashVisible(false);
                    setIsLoading(false); 
                }, 1500); 
                return () => clearTimeout(timer);
            }, []);


            // --- UI/Navigation Logic ---

            const handleNavigate = (screen) => {
                if (screen === 'plus') {
                    if (trips.length > 0) {
                        setShowModal('fabMenu');
                    } else {
                        setShowModal('newTrip');
                    }
                } else {
                    setCurrentScreen(screen);
                }
            };

            const handleSelectTrip = useCallback((tripId) => {
                setSelectedTripId(tripId);
                setCurrentScreen('home');
            }, []);

            // --- Persistence Handlers (Settings) ---

            const saveLocalSettings = useCallback((newSettings) => {
                const finalSettings = { 
                    theme: newSettings.theme !== undefined ? newSettings.theme : theme,
                    autoDarkMode: newSettings.autoDarkMode !== undefined ? newSettings.autoDarkMode : autoDarkMode,
                    rates: newSettings.rates !== undefined ? newSettings.rates : rates,
                };
                setRates(finalSettings.rates); // Ensure rates state is updated immediately
                saveToLocalStorage(LS_KEY_SETTINGS, finalSettings);
            }, [theme, autoDarkMode, rates]);

            useEffect(() => {
                if (autoDarkMode) {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    setTheme(prefersDark ? 'dark' : 'light');
                }
                document.documentElement.classList.toggle('dark', theme === 'dark');
            }, [theme, autoDarkMode]);

            const handleThemeChange = (newTheme) => {
                setTheme(newTheme);
                setAutoDarkMode(false); 
                saveLocalSettings({ theme: newTheme, autoDarkMode: false });
            };

            const handleToggleAutoDarkMode = () => {
                const newState = !autoDarkMode;
                setAutoDarkMode(newState);
                if (newState) {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    setTheme(prefersDark ? 'dark' : 'light');
                }
                saveLocalSettings({ autoDarkMode: newState });
            };

            const handleSaveRates = (newRates) => {
                setRates(newRates); // Update state
                saveLocalSettings({ rates: newRates }); // Save to storage
            };

            // --- Write Functions (Local Storage) ---

            const handleSaveNewTrip = (newTripData) => {
                setTrips(prev => [newTripData, ...prev]); 
                setSelectedTripId(newTripData.id);
                setCurrentScreen('home');
            };

            const handleSaveNewExpense = (newExpenseData) => {
                setExpenses(prev => [newExpenseData, ...prev]); 
            };
            
            const handleRenameTrip = (tripId, newName) => {
                setTrips(prev => prev.map(t => t.id === tripId ? { ...t, name: newName } : t));
                setActionTripId(null);
            };

            const handleDeleteTrip = (tripId) => {
                setTrips(prev => prev.filter(t => t.id !== tripId));
                setExpenses(prev => prev.filter(e => e.tripId !== tripId));
                
                if (selectedTripId === tripId) {
                    const remainingTrips = trips.filter(t => t.id !== tripId);
                    setSelectedTripId(remainingTrips.length > 0 ? remainingTrips[0].id : null);
                    setCurrentScreen('home');
                }
                setActionTripId(null);
            };

            // --- Screen Renderer ---
            const renderContent = () => {
                if (isLoading) {
                    return <LoadingIndicator message="Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡..." />;
                }
                
                switch (currentScreen) {
                    case 'home':
                        return <HomeScreen 
                            trips={trips} 
                            onSelectTrip={handleSelectTrip} 
                            selectedTrip={selectedTrip}
                            onActionTrip={setActionTripId}
                        />;
                    case 'reports':
                        return selectedTrip 
                            ? <ReportsScreen selectedTrip={selectedTrip} expenses={expenses} rates={rates} />
                            : <div className="p-6 text-center text-red-500 font-bold mt-20">âš ï¸ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø³ÙØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ú¯Ø²Ø§Ø±Ø´ Ø¢Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯.</div>;
                    case 'settings':
                        return <SettingsScreen 
                            theme={theme} 
                            onThemeChange={handleThemeChange} 
                            autoDarkMode={autoDarkMode} 
                            onToggleAutoDarkMode={handleToggleAutoDarkMode}
                            rates={rates}
                            onSaveRates={handleSaveRates}
                        />;
                    case 'about':
                        return <AboutScreen />;
                    default:
                        return <HomeScreen 
                            trips={trips} 
                            onSelectTrip={handleSelectTrip} 
                            selectedTrip={selectedTrip}
                            onActionTrip={setActionTripId}
                        />;
                }
            };

            return (
                <div className={`min-h-screen ${COLORS.tertiaryBg} ${COLORS.lightText} flex flex-col`} style={{ direction: 'rtl' }}>
                    <style>
                        {`
                        /* Adjust scrollbar colors for dark mode, subtle iOS style */
                        .dark ::-webkit-scrollbar-thumb {
                            background-color: #4b5563; 
                        }
                        .dark ::-webkit-scrollbar-track {
                            background: #1f2937; 
                        }
                        `}
                    </style>

                    <SplashScreen isVisible={isSplashVisible} />

                    {/* Fixed Header (iOS style title bar) */}
                    <header className={`${COLORS.secondaryBg} shadow-sm p-4 fixed top-0 left-0 right-0 z-30 border-b ${COLORS.separator}`}>
                        {selectedTrip ? (
                            <div className="flex justify-between items-center h-10">
                                <h1 className="text-xl font-bold truncate">
                                    {selectedTrip.name}
                                </h1>
                                <div className="flex items-center space-x-2 space-x-reverse text-sm">
                                    <span className={COLORS.mutedText}>Ø®Ø±Ø¬ Ø´Ø¯Ù‡:</span>
                                    <span className={`font-semibold text-ios-blue dark:text-blue-400`}>
                                        {formatCurrency(selectedTrip.spentUSD || 0)}
                                    </span>
                                </div>
                            </div>
                        ) : (
                            <h1 className="text-xl font-bold text-center text-ios-blue dark:text-blue-400 h-10">
                                Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ±
                            </h1>
                        )}
                    </header>

                    <main className="pt-20 pb-16 flex-grow overflow-y-auto">
                        {renderContent()}
                    </main>

                    <NavBar 
                        currentScreen={currentScreen} 
                        onNavigate={handleNavigate} 
                        selectedTrip={selectedTrip}
                    />

                    {/* PWA Installation Prompt */}
                    <PWAInstallPrompt 
                        isVisible={showInstallPrompt} 
                        onInstall={handleInstallClick} 
                        onDismiss={handleDismissInstall}
                    />


                    {/* Modals */}
                    {showModal === 'newTrip' && (
                        <NewTripDialog 
                            onClose={() => setShowModal(null)}
                            onSave={handleSaveNewTrip}
                        />
                    )}
                    {showModal === 'newExpense' && selectedTrip && (
                        <NewExpenseDialog
                            onClose={() => setShowModal(null)}
                            onSave={handleSaveNewExpense}
                            trip={selectedTrip}
                            rates={rates}
                        />
                    )}
                    
                    {/* FAB Menu */}
                    {showModal === 'fabMenu' && (
                        <FABMenu
                            onClose={() => setShowModal(null)}
                            isTripSelected={!!selectedTrip}
                            onNewTrip={() => setShowModal('newTrip')}
                            onNewExpense={() => setShowModal('newExpense')}
                        />
                    )}

                    {/* Trip Action Dialog (Rename/Delete) */}
                    {actionTrip && (
                        <TripActionDialog
                            trip={actionTrip}
                            onClose={() => setActionTripId(null)}
                            onRename={() => {
                                // Need to keep actionTrip in state for renaming
                                setActionTripId(actionTrip.id);
                                setShowModal('renameTrip'); 
                            }}
                            onDelete={handleDeleteTrip}
                        />
                    )}
                    
                    {/* Rename Trip Dialog */}
                    {showModal === 'renameTrip' && actionTrip && (
                        <NewTripDialog
                            onClose={() => {setShowModal(null); setActionTripId(null);}}
                            initialName={actionTrip.name}
                            onSave={(data) => {
                                handleRenameTrip(actionTrip.id, data.name);
                                setShowModal(null);
                                setActionTripId(null);
                            }}
                        />
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

