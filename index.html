<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>๐งณ ุฏุณุชุงุฑ ูุงู ุณูุฑูุง ุฎุงุฑุฌ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100">

<div id="root"></div>

<script type="text/babel">

const COLORS = {
    primary: 'bg-ios-blue',
    secondaryBg: 'bg-white dark:bg-gray-800',
    tertiaryBg: 'bg-gray-50 dark:bg-gray-900',
    separator: 'border-gray-200 dark:border-gray-700',
    mutedText: 'text-gray-500 dark:text-gray-400',
    lightText: 'text-gray-900 dark:text-gray-100',
    iosBlue: 'text-ios-blue dark:text-blue-400',
    dangerText: 'text-ios-red dark:text-red-500',
};

// --- Local Storage Utilities ---
const LS_KEY_TRIPS = 'trips';
const LS_KEY_EXPENSES = 'expenses';
const LS_KEY_SETTINGS = 'settings';
const LS_KEY_INSTALL_DISMISSED = 'installDismissed';

const loadFromLocalStorage = (key, defaultValue) => {
    try {
        const val = localStorage.getItem(key);
        return val ? JSON.parse(val) : defaultValue;
    } catch {
        return defaultValue;
    }
};

const saveToLocalStorage = (key, value) => {
    try {
        localStorage.setItem(key, JSON.stringify(value));
    } catch {}
};

const formatCurrency = (amount) => `$${amount.toFixed(2)}`;

const CURRENCY_MAP = {
    'ฺู': { code: 'CNY', flag: '๐จ๐ณ', defaultRate: 7.2 },
    'ุฏุจ': { code: 'AED', flag: '๐ฆ๐ช', defaultRate: 3.67 },
    'ุชุฑฺฉู': { code: 'TRY', flag: '๐น๐ท', defaultRate: 27.5 },
};

// --- Components ---

const SplashScreen = ({ isVisible }) => {
    if (!isVisible) return null;
    return (
        <div className="fixed inset-0 flex flex-col items-center justify-center bg-ios-blue text-white z-50">
            <h1 className="text-4xl font-extrabold mb-3 shadow-lg">โ๏ธ ุฏุณุชุงุฑ ูุงู<br />ุณูุฑูููููููุง ุฎุงุฑุฌ</h1>
            <p>ููุดุชู ุดุฏู ุจุง โค๏ธ ุชูุณุท ูุญูุฏ ุตุงุฏู ฺฉุงุฌ</p>
        </div>
    );
};

// NavBar & NavItem
const NavItem = ({ name, screen, icon, currentScreen, onNavigate, enabled }) => {
    const isActive = currentScreen === screen;
    const isDisabled = !enabled;

    return (
        <button
            onClick={() => !isDisabled && onNavigate(screen)}
            disabled={isDisabled}
            className={`
                flex flex-col items-center text-xs p-1 h-full transition-colors duration-200
                ${isDisabled 
                    ? 'text-gray-400 dark:text-gray-600 cursor-not-allowed' 
                    : (isActive ? 'text-ios-blue dark:text-blue-400' : 'text-gray-700 dark:text-gray-300 hover:text-ios-blue dark:hover:text-blue-400')
                }
            `}
        >
            <span className="text-xl mb-0.5">{icon}</span>
            <span className="font-medium">{name}</span>
        </button>
    );
};

const NavBar = ({ currentScreen, onNavigate, selectedTrip }) => {
    const isTripSelected = !!selectedTrip;

    const navItems = [
        { name: 'ุณูุฑูุง', screen: 'home', icon: '๐', enabled: true },
        { name: 'ฺฏุฒุงุฑุด', screen: 'reports', icon: '๐', enabled: isTripSelected },
        { name: 'ุชูุธูุงุช', screen: 'settings', icon: 'โ๏ธ', enabled: true },
        { name: 'ุฏุฑุจุงุฑู', screen: 'about', icon: 'โน๏ธ', enabled: true },
    ];

    const PlusButton = () => (
        <button
            onClick={() => onNavigate('plus')}
            className={`
                w-14 h-14 rounded-full -mt-6 shadow-xl shadow-ios-blue/50
                flex items-center justify-center text-3xl transition-transform
                transform hover:scale-105 active:scale-95 z-20 
                !text-white border-4 border-white dark:border-[#1C1C1E] bg-white dark:bg-white
            `}
            aria-label="ููู ุงฺฉุดู"
        >
            โ
        </button>
    );

    return (
        <nav className={`${COLORS.secondaryBg} shadow-2xl fixed bottom-0 left-0 right-0 z-40 border-t ${COLORS.separator} h-16`}>
            <div className="grid grid-cols-5 items-end h-full pt-2">
                {navItems.slice(0, 2).map(item => (
                    <NavItem key={item.name} {...item} currentScreen={currentScreen} onNavigate={onNavigate} />
                ))}
                <div className="flex justify-center">
                    <PlusButton />
                </div>
                {navItems.slice(2).map(item => (
                    <NavItem key={item.name} {...item} currentScreen={currentScreen} onNavigate={onNavigate} />
                ))}
            </div>
        </nav>
    );
};

// LoadingIndicator
const LoadingIndicator = ({ message = "ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ..." }) => (
    <div className="flex flex-col items-center justify-center h-full text-center p-6">
        <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-ios-blue dark:border-blue-400 mb-3"></div>
        <p className="font-medium">{message}</p>
    </div>
);

// AboutScreen
const AboutScreen = () => (
    <div className="p-4 pb-20 space-y-6">
        <h1 className="text-3xl font-bold pt-4 pb-2">ุฏุฑุจุงุฑู ูุง</h1>
        <div className={`${COLORS.secondaryBg} p-6 rounded-xl shadow-md border ${COLORS.separator} text-center`}>
            <p className="text-lg font-bold mb-4 text-ios-blue dark:text-blue-400">
                ุจุฑูุงูู ุฏุณุชุงุฑ ูุงู ุณูุฑูุง ุฎุงุฑุฌ
            </p>
            <p className={COLORS.mutedText}>
                ุงู ุจุฑูุงูู ุจุง ูุฏู ูุฏุฑุช ู ูพฺฏุฑ ูุฒููโูุง ุงุฑุฒ ุณูุฑุ ุจูโุตูุฑุช ฺฉ ูุจโุงูพูฺฉุดู ูุณุชูู (PWA) ุทุฑุงุญ ุดุฏู ุงุณุช.
            </p>
            <p className="mt-6 text-sm font-medium">
                ููุดุชู ุดุฏู ุจุง โค๏ธ ุชูุณุท ูุญูุฏ ุตุงุฏู ฺฉุงุฌ
            </p>
        </div>
    </div>
);

// PWA Install Prompt
const PWAInstallPrompt = ({ isVisible, onInstall, onDismiss }) => {
    if (!isVisible) return null;
    return (
        <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-ios-blue dark:bg-blue-500 text-white p-4 rounded-xl shadow-lg z-50 flex flex-col items-center space-y-2">
            <p className="font-medium">๐พ ูุตุจ ุงูพูฺฉุดู ุฑู ุฏุณุชฺฏุงู ุฎูุฏ</p>
            <div className="flex space-x-4 space-x-reverse">
                <button onClick={onInstall} className="px-3 py-1 bg-white dark:bg-gray-800 text-ios-blue rounded-md font-bold">ูุตุจ</button>
                <button onClick={onDismiss} className="px-3 py-1 border border-white rounded-md font-bold">ุฑุฏ</button>
            </div>
        </div>
    );
};

// --- MAIN APP ---
const App = () => {
    const initialSettings = loadFromLocalStorage(LS_KEY_SETTINGS, { 
        theme: 'light', 
        autoDarkMode: true, 
        rates: { 
            'CNY': CURRENCY_MAP['ฺู'].defaultRate, 
            'AED': CURRENCY_MAP['ุฏุจ'].defaultRate, 
            'TRY': CURRENCY_MAP['ุชุฑฺฉู'].defaultRate 
        }
    });

    const [trips, setTrips] = React.useState(loadFromLocalStorage(LS_KEY_TRIPS, []));
    const [expenses, setExpenses] = React.useState(loadFromLocalStorage(LS_KEY_EXPENSES, []));
    const [theme, setTheme] = React.useState(initialSettings.theme);
    const [autoDarkMode, setAutoDarkMode] = React.useState(initialSettings.autoDarkMode);
    const [rates, setRates] = React.useState(initialSettings.rates);
    const [selectedTripId, setSelectedTripId] = React.useState(null);
    const [currentScreen, setCurrentScreen] = React.useState('home');
    const [isSplashVisible, setIsSplashVisible] = React.useState(true);
    const [showModal, setShowModal] = React.useState(null);
    const [actionTripId, setActionTripId] = React.useState(null);
    const [isLoading, setIsLoading] = React.useState(false);
    const [deferredPrompt, setDeferredPrompt] = React.useState(null);
    const [showInstallPrompt, setShowInstallPrompt] = React.useState(false);

    const selectedTrip = React.useMemo(() => trips.find(t => t.id === selectedTripId), [trips, selectedTripId]);
    const actionTrip = React.useMemo(() => trips.find(t => t.id === actionTripId), [trips, actionTripId]);

    React.useEffect(() => {
        if (!selectedTripId && trips.length > 0) {
            setSelectedTripId(trips[0].id);
        }
    }, [trips, selectedTripId]);

    React.useEffect(() => {
        const handleBeforeInstallPrompt = (e) => {
            e.preventDefault();
            setDeferredPrompt(e);
            const dismissed = loadFromLocalStorage(LS_KEY_INSTALL_DISMISSED, false);
            if (!dismissed) setShowInstallPrompt(true);
        };
        const handleAppInstalled = () => {
            setDeferredPrompt(null);
            setShowInstallPrompt(false);
            saveToLocalStorage(LS_KEY_INSTALL_DISMISSED, false);
        };
        window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt
